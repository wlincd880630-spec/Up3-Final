<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Global Explorer: Learning Suite</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js"></script>

    <style>
        /* ================= 视觉系统 ================= */
        :root { 
            --bg-gradient: linear-gradient(135deg, #e0f2fe 0%, #f0fdf4 100%);
            --glass-bg: rgba(255, 255, 255, 0.95); 
            --primary: #0ea5e9;   /* Ocean Blue */
            --secondary: #10b981; /* Eco Green */
            --accent: #6366f1;    /* Indigo */
            --text-dark: #1e293b;
            --text-light: #64748b;
            --danger: #ef4444;
            --shadow-card: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
        }

        body { 
            margin: 0; font-family: 'Nunito', sans-serif; min-height: 100vh; overflow-y: auto; 
            background: var(--bg-gradient); color: var(--text-dark);
            display: flex; justify-content: center; align-items: flex-start; 
            user-select: none; padding: 20px 0; 
        }

        /* --- Home 按钮 (根目录) --- */
        .home-btn {
            position: fixed; top: 20px; left: 20px; z-index: 2000;
            background: white; color: var(--primary);
            padding: 10px 20px; border-radius: 50px; text-decoration: none;
            font-weight: 800; border: 2px solid #e0f2fe;
            box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
            transition: all 0.2s; display: flex; align-items: center; gap: 8px;
        }
        .home-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 15px rgba(14, 165, 233, 0.2); }

        /* --- 主容器 --- */
        #app-frame { 
            width: 95vw; max-width: 1200px; min-height: 90vh; 
            background: var(--glass-bg); border-radius: 32px; 
            border: 4px solid rgba(255,255,255,0.5); 
            box-shadow: var(--shadow-card);
            position: relative; display: flex; flex-direction: column; align-items: center; 
            overflow: hidden; padding-bottom: 80px; /* 底部留给控制栏 */
        }

        .view-section { display: none; width: 100%; flex-direction: column; align-items: center; animation: fadeIn 0.4s ease-out; padding-bottom: 40px; }
        .view-section.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- 导航栏 --- */
        .nav-bar { 
            width: 100%; padding: 25px 40px; 
            display: flex; justify-content: center; align-items: center;
            position: relative; margin-bottom: 10px;
        }
        .page-title { 
            font-family: 'Fredoka'; font-size: 2.4rem; color: var(--text-dark); margin: 0; 
            text-align: center; letter-spacing: -0.5px;
        }
        .nav-actions { position: absolute; right: 40px; display: flex; gap: 10px; }

        /* --- 通用按钮 --- */
        .btn {
            background: var(--text-dark); color: white; border: none; padding: 12px 24px;
            border-radius: 16px; font-size: 1rem; font-weight: 700; cursor: pointer;
            transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.15); filter: brightness(1.1); }
        .btn:active { transform: translateY(0); }
        
        .btn-primary { background: var(--primary); }
        .btn-secondary { background: var(--secondary); }
        .btn-accent { background: var(--accent); }
        .btn-outline { background: white; color: var(--text-dark); border: 2px solid #e2e8f0; }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-audio { background: #f1f5f9; color: var(--text-dark); border-radius: 50%; width: 44px; height: 44px; padding: 0; justify-content: center; box-shadow: none; }
        .btn-audio:hover { background: var(--primary); color: white; }

        /* ================= 1. 拼图区域 (04.html 逻辑) ================= */
        .game-area { flex: 1; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 20px; margin-top: 10px; }
        #puzzle-scaler { transform-origin: top center; transition: transform 0.3s; display: flex; flex-direction: column; align-items: center; gap: 25px; }

        #board-container { 
            position: relative; width: 600px; height: 500px; 
            background: #e2e8f0; border: 4px solid white; 
            border-radius: 20px; box-shadow: inset 0 2px 10px rgba(0,0,0,0.05); 
            flex-shrink: 0; overflow: visible; z-index: 1;
        }
        .grid-lines { 
            position: absolute; width: 100%; height: 100%; 
            background-image: linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px); 
            background-size: 100px 100px; pointer-events: none; border-radius: 16px; 
        }
        
        .pool-wrapper { position: relative; width: 700px; height: 240px; flex-shrink: 0; z-index: 50; }
        #pool-container { 
            width: 100%; height: 100%; background: rgba(255,255,255,0.6); 
            border: 3px dashed #cbd5e1; border-radius: 24px; 
            position: relative; overflow: visible !important;
        }
        .pool-hint { position: absolute; top: -16px; left: 50%; transform: translateX(-50%); background: var(--primary); color: white; padding: 6px 20px; border-radius: 20px; font-weight: 800; font-size: 0.9rem; z-index: 200; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3); }
        
        /* 拼图块：150px 大尺寸 */
        .puzzle-piece { 
            position: absolute; width: 150px; height: 150px; 
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); 
            transition: left 0.1s, top 0.1s; 
            -webkit-user-drag: none; border-radius: 0; margin: 0; padding: 0; display: block; 
        }
        .in-pool { cursor: grab; z-index: 100; }
        .in-pool:active { cursor: grabbing; z-index: 9999; transform: scale(1.05); }
        .on-board { z-index: 10; pointer-events: none; filter: none; }

        /* 底部控制栏 (美化布局) */
        .bottom-controls {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: white; padding: 10px 20px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); display: flex; gap: 15px; z-index: 1000;
            border: 1px solid rgba(255,255,255,0.5); backdrop-filter: blur(10px);
        }

        /* ================= 2. 语法部分 (头脑风暴模式) ================= */
        .grammar-container { width: 90%; max-width: 800px; display: flex; flex-direction: column; gap: 25px; padding-bottom: 100px; }
        
        .hero-card { 
            background: white; padding: 30px; border-radius: 24px; 
            text-align: center; box-shadow: var(--shadow-card); 
            border-bottom: 4px solid var(--secondary); position: relative;
        }
        .hero-text { font-size: 1.6rem; font-weight: 800; color: var(--text-dark); font-family: 'Fredoka'; margin-bottom: 20px; }
        .formula-box { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px; }
        .f-pill { padding: 8px 16px; border-radius: 12px; color: white; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .fp-1 { background: #64748b; } .fp-2 { background: var(--accent); } .fp-3 { background: #f59e0b; } .fp-4 { background: var(--primary); }

        .ex-card { 
            background: white; border-radius: 24px; padding: 25px; 
            border: 1px solid #f1f5f9; box-shadow: var(--shadow-card); 
            transition: 0.3s; 
        }
        .ex-card:hover { transform: translateY(-3px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); }
        
        .ex-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .ex-context { font-weight: 800; color: var(--primary); font-size: 0.95rem; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        .question-btn { width: 36px; height: 36px; border-radius: 50%; background: #f1f5f9; border: none; color: var(--text-light); font-weight: bold; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .question-btn:hover { background: var(--accent); color: white; }

        .card-content { display: none; animation: slideDown 0.3s ease-out; }
        .grammar-img { width: 100%; max-width: 400px; height: auto; border-radius: 16px; display: block; margin: 0 auto 20px auto; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .ex-question { font-size: 1.2rem; color: var(--text-dark); font-weight: 700; margin-bottom: 20px; text-align: center; font-style: italic; }

        /* 输入区域 (美化) */
        .brainstorm-area { 
            background: #f8fafc; padding: 15px; border-radius: 20px; margin-bottom: 15px; border: 2px dashed #e2e8f0;
        }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .brainstorm-input { 
            flex: 1; padding: 12px 20px; border-radius: 12px; border: 2px solid #cbd5e1; 
            font-size: 1rem; outline: none; transition: 0.2s; font-family: 'Nunito'; background: white;
        }
        .brainstorm-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        .add-btn { width: 48px; border-radius: 12px; font-size: 1.5rem; padding: 0; justify-content: center; background: var(--accent); color: white; border: none; cursor: pointer; transition: 0.2s; }
        .add-btn:hover { background: #4f46e5; }

        .ideas-cloud { display: flex; flex-wrap: wrap; gap: 8px; min-height: 10px; }
        .idea-tag { 
            background: white; padding: 6px 15px; border-radius: 20px; font-weight: 700; color: var(--accent);
            box-shadow: 0 2px 5px rgba(99, 102, 241, 0.15); font-size: 0.9rem; border: 1px solid #e0e7ff; animation: popIn 0.3s;
        }

        .reveal-btn { width: 100%; background: white; border: 2px solid #e2e8f0; color: var(--text-dark); border-radius: 12px; padding: 12px; font-weight: 700; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; gap: 8px; }
        .reveal-btn:hover { background: #f8fafc; border-color: var(--text-dark); }

        .answer-reveal { display: none; padding-top: 20px; border-top: 2px solid #f1f5f9; margin-top: 20px; animation: fadeIn 0.5s; }
        .target-sentence { 
            background: #f0fdf4; padding: 15px 20px; border-radius: 16px; border-left: 5px solid var(--secondary);
            margin-bottom: 10px;
        }
        .ts-text { font-size: 1.15rem; font-weight: 800; color: var(--text-dark); margin-bottom: 5px; }
        .ts-trans { font-size: 1rem; color: var(--text-light); }

        /* ================= 3. 练习部分 (Unscramble) ================= */
        .practice-container { width: 90%; max-width: 800px; display: flex; flex-direction: column; align-items: center; gap: 20px; }
        
        .progress-card {
            width: 100%; background: white; padding: 15px 30px; border-radius: 50px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow-card);
        }
        .progress-track { flex: 1; height: 10px; background: #f1f5f9; border-radius: 10px; margin: 0 20px; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--secondary); width: 0%; transition: 0.5s ease-out; }

        .audio-hint-btn {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white; padding: 12px 30px; border-radius: 50px; font-size: 1.1rem; font-weight: 700;
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3); border: none; cursor: pointer;
            transition: 0.2s; display: flex; align-items: center; gap: 10px;
        }
        .audio-hint-btn:hover { transform: scale(1.05); box-shadow: 0 10px 25px rgba(99, 102, 241, 0.4); }

        .drop-zone { 
            width: 100%; min-height: 120px; 
            background: white; border-radius: 20px; 
            border: 3px dashed #cbd5e1; 
            display: flex; flex-wrap: wrap; align-items: center; justify-content: center; 
            gap: 12px; padding: 25px; transition: 0.3s;
        }
        .drop-zone.correct { border-color: var(--secondary); background: #ecfdf5; border-style: solid; }
        .drop-zone.wrong { border-color: var(--danger); background: #fef2f2; animation: shake 0.4s; }
        .placeholder-text { color: #cbd5e1; font-size: 1.1rem; font-weight: 700; pointer-events: none; }

        .word-pool { display: flex; flex-wrap: wrap; justify-content: center; gap: 12px; width: 100%; min-height: 80px; }
        .word-tile { 
            background: white; padding: 12px 24px; border-radius: 14px; 
            font-weight: 800; color: var(--text-dark); font-size: 1.1rem;
            cursor: pointer; box-shadow: 0 4px 0 #e2e8f0; border: 1px solid #cbd5e1; 
            transition: 0.1s; user-select: none;
        }
        .word-tile:active { transform: translateY(4px); box-shadow: none; }
        .word-tile:hover { border-color: var(--primary); color: var(--primary); }
        .word-tile.used { opacity: 0; pointer-events: none; transform: scale(0.8); }

        /* 动画 */
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* 弹窗 */
        #success-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 3000; backdrop-filter: blur(5px); }
        .modal-box { background: white; padding: 40px; border-radius: 30px; text-align: center; animation: popIn 0.3s; max-width: 400px; width: 90%; }

        @media (max-width: 768px) {
            .nav-bar { padding: 20px; margin-top: 50px; grid-template-columns: 1fr; justify-items: center; }
            .nav-actions { position: static; margin-top: 10px; }
            .page-title { font-size: 1.6rem; }
            #board-container { margin-bottom: 20px; }
            .grammar-container, .practice-stage { width: 95%; }
            .hero-text { font-size: 1.2rem; }
            .f-pill { padding: 6px 12px; font-size: 0.9rem; }
            .ex-card { padding: 15px; }
            .grammar-img { max-width: 100%; }
            .word-tile { padding: 10px 16px; font-size: 1rem; }
            .bottom-controls { width: 90%; justify-content: center; bottom: 20px; }
        }
    </style>
</head>
<body>

<a href="../../index.html" class="home-btn"><i class="fas fa-home"></i> Home</a>

<div id="app-frame">
    
    <div id="view-puzzle" class="view-section active">
        <div class="nav-bar">
            <h1 class="page-title">Restoration Project</h1>
        </div>

        <div class="game-area">
            <div id="puzzle-scaler">
                <div id="board-container"><div class="grid-lines"></div></div>
                <div class="pool-wrapper">
                    <div id="pool-container">
                        <div class="pool-hint">Drag pieces to complete the poster</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-controls">
            <button id="shuffle-btn" class="btn btn-outline" onclick="scramblePool()">
                <i class="fas fa-sync-alt"></i> Shuffle
            </button>
            <button id="lesson-btn" class="btn btn-secondary" style="display: none;" onclick="switchView('view-grammar')">
                Start Lesson <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <div id="view-grammar" class="view-section">
        <div class="nav-bar">
            <h1 class="page-title">Grammar Focus</h1>
            <div class="nav-actions">
                <button class="btn btn-outline" onclick="switchView('view-puzzle')"><i class="fas fa-arrow-left"></i> Puzzle</button>
                <button class="btn btn-secondary" onclick="switchView('view-practice')">Practice <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <div class="grammar-container">
            <div class="hero-card">
                <div class="hero-text">"It is important for us to protect the environment."</div>
                <div class="formula-box">
                    <div class="f-pill fp-1">It is</div>
                    <div class="f-pill fp-2">Adj</div>
                    <div class="f-pill fp-3">for sb</div>
                    <div class="f-pill fp-4">to do sth</div>
                </div>
                <button class="btn btn-audio" style="position: absolute; right: 20px; top: 20px;" onclick="speak('It is important for us to protect the environment')"><i class="fas fa-volume-up"></i></button>
            </div>

            <div id="grammar-list"></div>
        </div>
    </div>

    <div id="view-practice" class="view-section">
        <div class="nav-bar">
            <h1 class="page-title">Unscramble Challenge</h1>
            <div class="nav-actions">
                <button class="btn btn-outline" onclick="switchView('view-grammar')"><i class="fas fa-arrow-left"></i> Grammar</button>
            </div>
        </div>

        <div class="practice-container">
            <div class="progress-card">
                <span id="q-count" style="font-weight:800; color:var(--text-light);">1 / 20</span>
                <div class="progress-track"><div class="progress-bar" id="p-bar"></div></div>
                <i class="fas fa-flag-checkered" style="color:var(--text-light);"></i>
            </div>

            <button class="audio-hint-btn" onclick="playCurrentHint()">
                <i class="fas fa-headphones"></i> Listen & Build
            </button>

            <div class="drop-zone" id="answer-zone">
                <div class="placeholder-text">Tap words to build the sentence...</div>
            </div>

            <div class="word-pool" id="word-pool"></div>

            <div class="bottom-controls" style="position: static; transform: none; box-shadow: none; border: none; background: transparent;">
                <button id="check-btn" class="btn btn-primary" onclick="checkAnswer()">Check Answer</button>
                <button id="next-btn" class="btn btn-secondary" style="display:none;" onclick="nextQuestion()">Next Sentence <i class="fas fa-arrow-right"></i></button>
            </div>
        </div>
    </div>

</div>

<div id="success-modal">
    <div class="modal-box">
        <div style="font-size: 4rem; color: var(--secondary); margin-bottom: 15px;"><i class="fas fa-trophy"></i></div>
        <h2 style="font-size: 2rem; margin: 0 0 10px 0; color: var(--text-dark);">Awesome!</h2>
        <p style="color: var(--text-light); margin-bottom: 25px; font-size: 1.1rem;">Restoration Complete.</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button class="btn btn-outline" onclick="closeModal()">View Artwork</button>
            <button class="btn btn-primary" onclick="closeModalAndNext()">Start Lesson</button>
        </div>
    </div>
</div>

<script>
    // ================== Azure Speech SDK ==================
    const azureKey = "DKRXk8ueSfo5NdIOMqFRTCAfpeGDezJ3Snf5K8gGgtyqxiWdugLzJQQJ99BLACHYHv6XJ3w3AAAYACOGUYP9";
    const azureRegion = "eastus2"; 
    let currentSynthesizer = null;

    function speak(text) {
        if (currentSynthesizer) { currentSynthesizer.close(); currentSynthesizer = null; }
        if (!text) return;
        try {
            const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(azureKey, azureRegion);
            speechConfig.speechSynthesisVoiceName = "en-US-JennyNeural"; 
            const audioConfig = SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
            const synthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig, audioConfig);
            currentSynthesizer = synthesizer;
            synthesizer.speakTextAsync(text, result => {
                synthesizer.close(); currentSynthesizer = null;
            }, err => { console.error(err); synthesizer.close(); currentSynthesizer = null; });
        } catch (e) { console.error("Azure Error", e); }
    }

    // ================== Puzzle Logic (Corrected 150px) ==================
    const ROWS = 5;
    const COLS = 6;
    const CELL_SIZE = 100;
    const OFFSET = 25; // Negative margin logic from 04.html
    const TARGET_ROW = 3;
    const SNAP_DIST = 40;
    let pieces = [];
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function initPuzzle() {
        const board = document.getElementById('board-container');
        const pool = document.getElementById('pool-container');
        let count = 1;

        for(let r=0; r<ROWS; r++){
            for(let c=0; c<COLS; c++){
                const numStr = count < 10 ? '0' + count : count;
                const img = document.createElement('img');
                img.src = `p${numStr}.png`;
                img.className = 'puzzle-piece';
                img.draggable = false;
                img.onerror = function(){this.onerror=null; this.src=`https://placehold.co/150x150/e2e8f0/64748b?text=${numStr}`};

                const isTarget = (r === TARGET_ROW);
                // 还原 04.html 的偏移量逻辑
                const correctLeft = c * CELL_SIZE - OFFSET;
                const correctTop = r * CELL_SIZE - OFFSET;

                const pieceData = { element: img, correctLeft, correctTop, isLocked: !isTarget, isTarget, currentRot: 0 };
                pieces.push(pieceData);

                if(isTarget) {
                    img.classList.add('in-pool');
                    pool.appendChild(img);
                    addDrag(img, pieceData);
                } else {
                    img.classList.add('on-board');
                    img.style.left = correctLeft + 'px';
                    img.style.top = correctTop + 'px';
                    board.appendChild(img);
                }
                count++;
            }
        }
        scramblePool();
    }

    function scramblePool() {
        const poolW = 700; const poolH = 240;
        pieces.forEach(p => {
            if(p.isTarget && !p.isLocked) {
                p.element.style.left = Math.random() * (poolW - 150) + 10 + 'px';
                p.element.style.top = Math.random() * (poolH - 150) + 10 + 'px';
                p.element.style.transform = `rotate(${Math.random() * 20 - 10}deg)`;
            }
        });
        playSound('shuffle');
    }

    function addDrag(el, data) {
        el.onmousedown = el.ontouchstart = function(e) {
            if(data.isLocked) return;
            e.preventDefault(); playSound('pickup');
            
            const scaler = document.getElementById('puzzle-scaler');
            const scale = scaler.getBoundingClientRect().width / scaler.offsetWidth || 1;

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const initLeft = parseFloat(el.style.left);
            const initTop = parseFloat(el.style.top);
            
            el.style.zIndex = 9999; el.style.transform = "scale(1.1)";

            function onMove(ev) {
                ev.preventDefault();
                const cx = ev.touches ? ev.touches[0].clientX : ev.clientX;
                const cy = ev.touches ? ev.touches[0].clientY : ev.clientY;
                const dx = (cx - clientX) / scale;
                const dy = (cy - clientY) / scale;
                el.style.left = (initLeft + dx) + 'px';
                el.style.top = (initTop + dy) + 'px';
            }

            function onEnd() {
                document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onEnd);
                document.removeEventListener('touchmove', onMove); document.removeEventListener('touchend', onEnd);
                checkSnap(el, data);
            }
            document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onEnd);
            document.addEventListener('touchmove', onMove, {passive:false}); document.addEventListener('touchend', onEnd);
        };
    }

    function checkSnap(el, data) {
        const board = document.getElementById('board-container'); 
        const boardRect = board.getBoundingClientRect();
        const elRect = el.getBoundingClientRect();
        const elCenterX = elRect.left + elRect.width/2;
        const elCenterY = elRect.top + elRect.height/2;
        
        const scaler = document.getElementById('puzzle-scaler');
        const scale = scaler.getBoundingClientRect().width / scaler.offsetWidth || 1;

        // 目标位置计算 (75 = 150/2 center)
        const targetScreenX = boardRect.left + (data.correctLeft + OFFSET + 75) * scale; 
        const targetScreenY = boardRect.top + (data.correctTop + OFFSET + 75) * scale;

        if (Math.hypot(elCenterX - targetScreenX, elCenterY - targetScreenY) < 50) {
            el.style.position = 'absolute'; board.appendChild(el);
            el.style.left = data.correctLeft + 'px'; el.style.top = data.correctTop + 'px';
            el.style.transform = 'none'; el.classList.remove('in-pool'); el.classList.add('on-board');
            data.isLocked = true; playSound('snap'); checkWin();
        } else {
            playSound('drop'); el.style.transform = `rotate(${Math.random()*10-5}deg)`; el.style.zIndex = 100;
        }
    }

    function checkWin() {
        if(pieces.every(p => p.isLocked)) {
            playSound('success');
            document.getElementById('success-modal').style.display = 'flex';
            // 显示 Start Lesson 按钮，隐藏 Shuffle
            document.getElementById('lesson-btn').style.display = 'inline-flex';
            document.getElementById('shuffle-btn').style.display = 'none';
            speak("Puzzle complete! Great job.");
        }
    }
    function closeModal() { document.getElementById('success-modal').style.display = 'none'; }
    function closeModalAndNext() { closeModal(); switchView('view-grammar'); }

    // ================== Grammar (Brainstorm Mode) ==================
    const grammarData = [
        { context: "Mom nagging all day", img: "img_0.jpg", question: "How do you feel when Mom repeats 'Clean your room' every 5 minutes?", adjective: "Irritating", sentence: "It is irritating for me to hear her complain all the time.", translation: "一直听到她的抱怨对我来说很烦人。" },
        { context: "Slow computer connection", img: "img_1.jpg", question: "You are winning a game, but screen freezes. How does it feel?", adjective: "Frustrating", sentence: "It is frustrating for gamers to lose connection during a match.", translation: "对游戏玩家来说，比赛中途断线是很令人沮丧的。" },
        { context: "Cancelled plans due to rain", img: "img_2.jpg", question: "You planned a picnic for Sunday, but now it is storming outside. Thoughts?", adjective: "Disappointing", sentence: "It is disappointing for the family to cancel their trip due to rain.", translation: "因为下雨取消旅行对这家人来说很令人失望。" },
        { context: "Long commute after work", img: "img_3.jpg", question: "How does your body feel after standing on a crowded bus for 2 hours?", adjective: "Tiring", sentence: "It is tiring for commuters to stand on the bus for so long.", translation: "对通勤者来说，在公交车上站这么久是很累人的。" },
        { context: "Finally cleaning a messy room", img: "img_4.jpg", question: "Look at the shiny clean kitchen after you scrubbed it. How does it feel?", adjective: "Satisfying", sentence: "It is satisfying for him to see the clean room after working all day.", translation: "对他来说，劳动一天后看到整洁的房间是很满足的。" },
        { context: "Facing difficulties in life", img: "img_5.jpg", question: "When things go wrong, should we give up or stay positive?", adjective: "Important", sentence: "It is important for us to keep a positive mindset in difficult times.", translation: "在困难时期，保持积极的心态对我们来说很重要。" },
        { context: "Soaking in a hot spring", img: "img_6.jpg", question: "Imagine sitting in hot water after a long hike. How does it feel?", adjective: "Relaxing", sentence: "It is relaxing for guests to sit in the hot spring.", translation: "对客人们来说，坐在温泉里是很放松的。" },
        { context: "Forgetting a friend's name", img: "img_7.jpg", question: "You want to introduce your friend, but your mind goes blank! How do you feel?", adjective: "Embarrassing", sentence: "It is embarrassing for me to forget my best friend's name.", translation: "忘记我最好朋友的名字让我感到很尴尬。" },
        { context: "Unexpected talent", img: "img_8.jpg", question: "Your quiet friend suddenly sings like a pop star! What is your reaction?", adjective: "Surprising", sentence: "It is surprising for everyone to hear his amazing voice.", translation: "听到他美妙的歌声让大家很惊讶。" },
        { context: "Learning a new instrument", img: "img_9.jpg", question: "Is it easy to make a violin sound good on the first day?", adjective: "Challenging", sentence: "It is challenging for beginners to play the violin correctly.", translation: "对初学者来说，正确演奏小提琴是具有挑战性的。" }
    ];

    function initGrammar() {
        const container = document.getElementById('grammar-list');
        grammarData.forEach((item, idx) => {
            const card = document.createElement('div');
            card.className = 'ex-card';
            card.innerHTML = `
                <div class="ex-header">
                    <div class="ex-context"><i class="fas fa-bolt" style="color:var(--accent);"></i> ${item.context}</div>
                    <button class="question-btn" onclick="toggleCard(${idx})"><i class="fas fa-question"></i></button>
                </div>
                <div id="card-content-${idx}" class="card-content">
                    <div class="ex-question">"${item.question}"</div>
                    <img src="${item.img}" class="grammar-img" onerror="this.src='https://placehold.co/400x250/e2e8f0/64748b?text=Image'">
                    
                    <div class="brainstorm-area">
                        <div class="input-group">
                            <input type="text" class="brainstorm-input" id="input-${idx}" placeholder="Type an adjective..." onkeypress="if(event.key==='Enter') addStudentIdea(${idx})">
                            <button class="add-btn" onclick="addStudentIdea(${idx})">+</button>
                        </div>
                        <div class="ideas-cloud" id="cloud-${idx}"></div>
                    </div>

                    <button class="reveal-btn" onclick="revealAnswer(${idx})">Reveal Answer <i class="fas fa-chevron-down"></i></button>

                    <div id="target-${idx}" class="answer-reveal">
                        <div class="target-sentence">
                            <div class="ts-text">${item.sentence}</div>
                            <div class="ts-trans">${item.translation}</div>
                        </div>
                        <button class="btn btn-audio" onclick="speak(\`${item.sentence.replace(/'/g, "\\'")}\`)"><i class="fas fa-volume-up"></i></button>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function toggleCard(idx) {
        const content = document.getElementById(`card-content-${idx}`);
        content.style.display = content.style.display === 'block' ? 'none' : 'block';
        playSound('click');
        if(content.style.display === 'block') document.getElementById(`input-${idx}`).focus();
    }

    function addStudentIdea(idx) {
        const input = document.getElementById(`input-${idx}`);
        const text = input.value.trim();
        const cloud = document.getElementById(`cloud-${idx}`);
        
        if(text) {
            const tag = document.createElement('div');
            tag.className = 'idea-tag';
            tag.innerText = text;
            cloud.appendChild(tag);
            input.value = '';
            input.focus();
            playSound('snap');
        }
    }

    function revealAnswer(idx) {
        document.getElementById(`target-${idx}`).style.display = 'block';
        playSound('success');
        speak(grammarData[idx].sentence);
    }

    // ================== Practice (Audio Hint) ==================
    const practiceSentences = [
        "It is healthy for us to eat fresh vegetables.", "It is polite for guests to bring a small gift.", "It is risky for beginners to ski alone.",
        "It is exciting for fans to watch the game live.", "It is boring for him to wait in the long line.", "It is strange for the dog to be so quiet today.",
        "It is vital for drivers to wear their seatbelts.", "It is unfair for them to do all the heavy work.", "It is convenient for you to pay the bill online.",
        "It is typical for cats to sleep all afternoon.", "It is stressful for students to have three exams.", "It is lovely for the couple to walk on the beach.",
        "It is scary for me to watch horror movies alone.", "It is wise for travelers to buy travel insurance.", "It is careless for him to leave the door unlocked.",
        "It is creative for kids to draw on the walls.", "It is impressive for her to speak four languages.", "It is confusing for tourists to read this old map.",
        "It is joyful for parents to see their baby walk.", "It is noisy for neighbors to have a party at night."
    ];
    let currentQIdx = 0;
    let currentTarget = "";
    let currentAttempt = [];

    function initPractice() {
        loadQuestion();
    }

    function loadQuestion() {
        if(currentQIdx >= practiceSentences.length) {
            document.getElementById('answer-zone').innerHTML = "<h3 style='color:var(--success);'>Course Completed!</h3>";
            return;
        }
        document.getElementById('q-count').innerText = `${currentQIdx + 1} / ${practiceSentences.length}`;
        document.getElementById('p-bar').style.width = `${((currentQIdx)/practiceSentences.length)*100}%`;
        
        currentTarget = practiceSentences[currentQIdx].replace(/[.,]/g, "");
        const words = currentTarget.split(" ").sort(() => Math.random() - 0.5);
        
        currentAttempt = [];
        renderPool(words);
        renderAnswer();
        document.getElementById('check-btn').style.display = 'inline-block';
        document.getElementById('next-btn').style.display = 'none';
        document.getElementById('answer-zone').className = 'drop-zone';
    }

    function playCurrentHint() {
        speak(practiceSentences[currentQIdx]);
    }

    function renderPool(words) {
        const pool = document.getElementById('word-pool');
        pool.innerHTML = '';
        words.forEach(w => {
            const btn = document.createElement('div');
            btn.className = 'word-tile';
            btn.innerText = w;
            btn.onclick = () => { 
                currentAttempt.push(w); 
                btn.classList.add('used');
                renderAnswer();
                playSound('click');
            };
            pool.appendChild(btn);
        });
    }

    function renderAnswer() {
        const zone = document.getElementById('answer-zone');
        zone.innerHTML = '';
        if(currentAttempt.length === 0) zone.innerHTML = '<div class="placeholder-text">Listen and tap words...</div>';
        currentAttempt.forEach((w, i) => {
            const btn = document.createElement('div');
            btn.className = 'word-tile';
            btn.innerText = w;
            btn.style.background = '#e0f2fe';
            btn.style.color = 'var(--primary)';
            btn.onclick = () => {
                currentAttempt.splice(i, 1);
                // Reset pool item logic (simplified)
                const poolBtns = document.querySelectorAll('#word-pool .word-tile');
                for(let b of poolBtns) { if(b.innerText === w && b.classList.contains('used')) { b.classList.remove('used'); break; } }
                renderAnswer();
                playSound('click');
            };
            zone.appendChild(btn);
        });
    }

    function checkAnswer() {
        const attemptStr = currentAttempt.join(" ");
        const zone = document.getElementById('answer-zone');
        if(attemptStr === currentTarget) {
            zone.classList.add('correct');
            playSound('success');
            speak(practiceSentences[currentQIdx]);
            document.getElementById('check-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'inline-block';
        } else {
            zone.classList.add('wrong'); playSound('error');
            setTimeout(() => zone.classList.remove('wrong'), 500);
        }
    }

    function nextQuestion() { currentQIdx++; loadQuestion(); }

    // ================== Utils ==================
    function playSound(type) {
        if(audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination); const now = audioCtx.currentTime;
        if (type === 'pickup') { osc.frequency.setValueAtTime(300, now); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.1); osc.start(now); osc.stop(now + 0.1); }
        else if (type === 'snap') { osc.frequency.setValueAtTime(800, now); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.1); osc.start(now); osc.stop(now + 0.1); }
        else if (type === 'click') { osc.frequency.setValueAtTime(600, now); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.05); osc.start(now); osc.stop(now + 0.05); }
        else if (type === 'drop') { osc.frequency.setValueAtTime(150, now); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0, now + 0.1); osc.start(now); osc.stop(now + 0.1); }
        else if (type === 'shuffle') { osc.frequency.setValueAtTime(400, now); gain.gain.setValueAtTime(0.03, now); osc.frequency.linearRampToValueAtTime(200, now + 0.2); gain.gain.linearRampToValueAtTime(0, now + 0.2); osc.start(now); osc.stop(now + 0.2); }
        else if (type === 'success') { [440, 554, 659].forEach((f, i) => { const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = f; g.gain.setValueAtTime(0.05, now + i*0.1); g.gain.linearRampToValueAtTime(0, now + i*0.1 + 0.3); o.start(now + i*0.1); o.stop(now + i*0.1 + 0.3); }); }
        else if (type === 'error') { osc.type='sawtooth'; osc.frequency.setValueAtTime(150, now); gain.gain.setValueAtTime(0.1, now); gain.gain.linearRampToValueAtTime(0, now + 0.3); osc.start(now); osc.stop(now + 0.3); }
    }

    function resizeApp() {
        const appFrame = document.getElementById('app-frame');
        const scaler = document.getElementById('puzzle-scaler');
        if (appFrame.clientWidth < 750) {
            const scale = (appFrame.clientWidth - 40) / 720;
            scaler.style.transform = `scale(${scale})`;
            scaler.style.marginBottom = `-${(1 - scale) * 800}px`; 
        } else {
            scaler.style.transform = 'scale(1)';
            scaler.style.marginBottom = '0';
        }
    }

    window.onload = function() {
        initPuzzle(); initGrammar(); initPractice(); resizeApp();
        window.addEventListener('resize', resizeApp);
    }

    function switchView(viewId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        if(viewId === 'view-puzzle') setTimeout(resizeApp, 100);
    }
</script>
</body>
</html>