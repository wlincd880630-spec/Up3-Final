<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page 02: First Reading</title>
    <script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Nunito:wght@400;700&family=Playfair+Display:ital,wght@0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-red: #C8102E;
            --royal-blue: #003399;
            --gold: #D4AF37;
            --text-bg: #000000;
        }

        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Nunito', sans-serif; overflow: hidden; background: #000; color: #fff; }

        .main-container { display: grid; grid-template-columns: 40% 60%; height: 100vh; }

        /* --- 左侧面板 --- */
        .left-panel {
            background: var(--text-bg); padding: 40px; display: flex; flex-direction: column;
            border-right: 1px solid #333; overflow-y: auto; z-index: 10; position: relative;
        }
        .left-panel::-webkit-scrollbar { width: 6px; }
        .left-panel::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        .lesson-header {
            border-bottom: 2px solid var(--primary-red); padding-bottom: 20px; margin-bottom: 20px;
        }
        .lesson-tag { 
            font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; color: #888; letter-spacing: 2px; display: block; margin-bottom: 5px;
        }
        .article-title {
            font-family: 'Bebas Neue', sans-serif; font-size: 3rem; color: #fff; line-height: 1; text-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        /* 课前问题框 */
        #pre-questions-box {
            background: rgba(255,255,255,0.1); border: 1px solid var(--gold); border-radius: 12px;
            padding: 25px; margin-bottom: 20px; color: #fff; flex-shrink: 0; transition: all 0.5s ease;
        }
        #pre-questions-box h3 { margin-top: 0; color: var(--gold); display: flex; gap:10px; align-items: center; }
        .q-item { margin-bottom: 15px; border-left: 3px solid var(--royal-blue); padding-left: 10px; }
        .q-text { font-size: 1.1rem; font-weight: bold; margin-bottom: 5px; }

        /* 文章容器 */
        #article-container { display: none; opacity: 0; margin-top: 20px; padding-bottom: 50px; }
        
        .para-block { margin-bottom: 30px; border-left: 1px solid #333; padding-left: 15px; transition: 0.3s; }
        .para-block:hover { border-left-color: var(--gold); }
        /* 第一段高亮样式 */
        .para-block.highlight-topic p { color: var(--gold); text-shadow: 0 0 1px var(--gold); transition: color 1s; }
        .para-block.highlight-topic { border-left: 3px solid var(--primary-red); background: rgba(200, 16, 46, 0.05); }

        .para-tools { display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
        .tool-btn {
            background: #222; border: 1px solid #444; color: #ccc; 
            height: 30px; padding: 0 12px; border-radius: 15px; cursor: pointer; font-size: 0.8rem;
            display: inline-flex; align-items: center; gap: 5px; transition: 0.2s;
        }
        .tool-btn:hover { border-color: var(--gold); color: #fff; }
        .tool-btn.playing { background: var(--primary-red); border-color: var(--primary-red); color: #fff; }

        .para-text { font-family: 'Playfair Display', serif; font-size: 1.15rem; line-height: 1.6; color: #ddd; text-align: justify; margin: 0; }

        /* 按钮 */
        .action-btn {
            background: var(--primary-red); color: #fff; border: none; padding: 12px 30px;
            font-size: 1.1rem; border-radius: 30px; cursor: pointer; transition: 0.3s; font-weight: bold;
            margin-top: 10px; display: inline-flex; align-items: center; gap: 8px;
        }
        .action-btn:hover { transform: scale(1.05); background: #fff; color: #C8102E; }
        .action-btn.gold { background: var(--gold); color: #000; }

        /* --- 右侧面板 (修改布局为相对定位容器，允许绝对定位叠加) --- */
        .right-panel { 
            position: relative; width: 100%; height: 100%; overflow: hidden; 
            background: #111; 
        }

        /* 2. 地图区域 (修改为铺满底层) */
        #map-wrapper { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; /* 在最底层 */
        }
        #map { width: 100%; height: 100%; z-index: 1; }
        
        /* 1. 顶部海报 3D 滚动区 (修改为悬浮透明) */
        #poster-marquee-container {
            position: absolute; top: 0; left: 0; width: 100%;
            height: 180px; 
            z-index: 20; /* 悬浮在地图之上 */
            
            perspective: 800px;
            overflow: hidden;

            /* 核心修改：透明背景渐变 */
            /* 上方稍微深一点保证海报清楚，下方完全透明融入地图 */
            background: linear-gradient(to bottom, rgba(0,0,0,0.6) 0%, rgba(0,0,0,0) 100%);
            border-bottom: none; 

            /* 允许鼠标穿透空白区域操作地图 */
            pointer-events: none; 
        }

        .marquee-content {
            display: flex; 
            height: 100%; 
            width: max-content;
            transform-style: preserve-3d;
            transform: rotateY(20deg) rotateZ(-2deg) translateX(-20px); 
            transform-origin: left center;
            animation: scrollMarquee3D 40s linear infinite;
            
            /* 恢复海报的鼠标事件 */
            pointer-events: auto; 
        }

        @keyframes scrollMarquee3D {
            0% { transform: rotateY(20deg) rotateZ(-2deg) translateX(0); }
            100% { transform: rotateY(20deg) rotateZ(-2deg) translateX(-50%); }
        }

        .poster-img {
            height: 85%; width: auto; aspect-ratio: 2/3; object-fit: cover;
            margin-right: 25px; border-radius: 6px;
            /* 增强阴影，使海报在地图上更立体 */
            box-shadow: 0 10px 20px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.2);
            transition: 0.3s; 
            filter: brightness(0.9);
            cursor: pointer;
        }
        .poster-img:hover { 
            filter: brightness(1.2); 
            transform: scale(1.1) translateZ(30px); 
            box-shadow: 0 15px 30px rgba(0,0,0,0.8);
            border-color: var(--gold);
            z-index: 100;
        }

        /* 遮罩：使用半透明黑，而非纯黑，避免硬切边 */
        #poster-marquee-container::after {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(90deg, rgba(0,0,0,0.7) 0%, transparent 15%, transparent 85%, rgba(0,0,0,0.7) 100%);
            pointer-events: none; z-index: 10;
        }

        /* 底部问题框 */
        #map-overlay-container {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 10;
            padding: 20px; pointer-events: none; display: flex; justify-content: center;
        }
        #pre-questions-box.moved {
            pointer-events: auto; background: rgba(0, 0, 0, 0.9);
            border-top: 3px solid var(--gold); border-radius: 12px 12px 0 0;
            width: 90%; max-width: 800px; padding: 15px 25px; box-shadow: 0 -5px 20px rgba(0,0,0,0.8);
        }
        #pre-questions-box.moved h3 { font-size: 1rem; margin-bottom: 10px; }
        #pre-questions-box.moved .q-text { font-size: 0.95rem; font-weight: normal; margin-bottom: 0; }
        #pre-questions-box.moved .q-item { border-left: none; border-bottom: 1px solid #333; padding: 5px 0; margin-bottom: 0; }
        
        /* --- 右侧：Interactive Overlay --- */
        #right-interaction-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 100;
            display: none; flex-direction: column; padding: 40px; overflow-y: auto;
            box-sizing: border-box;
        }

        .interaction-step { display: none; max-width: 700px; margin: 0 auto; width: 100%; animation: slideInRight 0.5s ease; }
        .interaction-step.active { display: block; }
        
        .step-title { color: var(--gold); font-size: 1.8rem; margin-bottom: 20px; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .step-subtitle { color: #aaa; margin-bottom: 20px; font-style: italic; }

        /* 文体卡片样式 */
        .type-card {
            background: #222; border: 1px solid #444; border-radius: 8px; padding: 20px; margin-bottom: 15px;
            cursor: pointer; transition: 0.3s; position: relative; display: flex; flex-direction: column;
        }
        .type-card:hover { border-color: var(--gold); background: #2a2a2a; transform: translateX(5px); }
        .type-card.correct { border-color: #2ecc71; background: rgba(46, 204, 113, 0.1); }
        .type-card.wrong { border-color: #e74c3c; background: rgba(231, 76, 60, 0.1); }

        .type-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .type-name { font-size: 1.2rem; font-weight: bold; color: #fff; }
        .type-def { color: #aaa; font-style: italic; font-size: 1rem; }
        
        .mini-tts-btn {
            width: 30px; height: 30px; border-radius: 50%; background: #333; color: #fff;
            display: flex; align-items: center; justify-content: center; cursor: pointer; border: 1px solid #555; transition: 0.2s;
        }
        .mini-tts-btn:hover { background: var(--primary-red); border-color: var(--primary-red); transform: scale(1.1); }

        /* Quiz 通用样式 */
        .quiz-item { margin-bottom: 25px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; }
        .quiz-q { font-weight: bold; margin-bottom: 10px; font-size: 1.1rem; color: #ddd; }
        .quiz-opts { display: grid; gap: 8px; }
        .q-opt { 
            padding: 10px; background: #111; border: 1px solid #333; cursor: pointer; border-radius: 4px; transition: 0.2s;
        }
        .q-opt:hover { border-color: var(--gold); }
        .q-opt.correct { background: #27ae60; color: #fff; border-color: #27ae60; }
        .q-opt.wrong { background: #c0392b; color: #fff; border-color: #c0392b; }

        @keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }

    </style>
</head>
<body>

    <div class="main-container">
        <div class="left-panel">
            <div class="lesson-header">
                <span class="lesson-tag">FIRST READING</span>
                <div class="article-title">A MOVIE-GOER’S GUIDE TO LONDON</div>
            </div>

            <div id="pre-questions-box">
                <h3><i class="fas fa-question-circle"></i> Pre-reading Questions</h3>
                <div class="q-item">
                    <div class="q-text">1. What type of text is this?</div>
                </div>
                <div class="q-item">
                    <div class="q-text">2. What is the main idea of the text?</div>
                </div>
            </div>

            <button id="btn-start-read" class="action-btn" onclick="startReading()">
                <i class="fas fa-book-open"></i> Start Reading
            </button>

            <div id="article-container">
                <div class="para-block" id="para-1">
                    <div class="para-tools">
                        <button class="tool-btn" onclick="playText(this, 'p1-txt')"><i class="fas fa-volume-up"></i> Play</button>
                    </div>
                    <p class="para-text" id="p1-txt">London has been the setting for many popular movies—from James Bond to Harry Potter. So if you are visiting the UK’s capital, why not follow this walking tour and explore some interesting movie locations?</p>
                </div>

                <div class="para-block">
                    <div class="para-tools">
                        <button class="tool-btn" onclick="playText(this, 'p2-txt')"><i class="fas fa-volume-up"></i> Play</button>
                        <button class="tool-btn" onclick="showLocation('Museum')"><i class="fas fa-map-marker-alt"></i> Film Museum</button>
                        <button class="tool-btn" onclick="showLocation('Garden')"><i class="fas fa-map-marker-alt"></i> Covent Garden</button>
                    </div>
                    <p class="para-text" id="p2-txt">Start at the London Film Museum. Here, you can see a collection of items from many famous movies. The museum is near Covent Garden—a famous market. And while you’re there, you should check out some of the amazing street performers.</p>
                </div>

                <div class="para-block">
                    <div class="para-tools">
                        <button class="tool-btn" onclick="playText(this, 'p3-txt')"><i class="fas fa-volume-up"></i> Play</button>
                        <button class="tool-btn" onclick="showLocation('Sheekey')"><i class="fas fa-map-marker-alt"></i> J. Sheekey</button>
                    </div>
                    <p class="para-text" id="p3-txt">Next, walk down King Street, then along New Row to J Sheekey. This restaurant is a great place to see TV and movie stars. And it’s not too expensive; you can get a great meal for under £25.</p>
                </div>

                <div class="para-block">
                    <div class="para-tools">
                        <button class="tool-btn" onclick="playText(this, 'p4-txt')"><i class="fas fa-volume-up"></i> Play</button>
                        <button class="tool-btn" onclick="showLocation('Leicester')"><i class="fas fa-map-marker-alt"></i> Leicester Sq</button>
                    </div>
                    <p class="para-text" id="p4-txt">Nearby is Leicester Square, known as London’s “Theatreland.” Many famous movie premieres are held in the square, and it is also home to the London Film Festival. One of the exits of the Leicester Square underground station appears in the movie Harry Potter and the Half-Blood Prince.</p>
                </div>

                <div class="para-block">
                    <div class="para-tools">
                        <button class="tool-btn" onclick="playText(this, 'p5-txt')"><i class="fas fa-volume-up"></i> Play</button>
                    </div>
                    <p class="para-text" id="p5-txt">To get away from the crowds, you should spend some time in Leicester Square Gardens. Here, you’ll see a statue of William Shakespeare. Shakespeare wrote his most famous plays while he was living in London. Many of his plays, such as Macbeth, were later made into movies.</p>
                </div>

                <div class="para-block">
                    <div class="para-tools">
                        <button class="tool-btn" onclick="playText(this, 'p6-txt')"><i class="fas fa-volume-up"></i> Play</button>
                        <button class="tool-btn" onclick="showLocation('Gallery')"><i class="fas fa-map-marker-alt"></i> National Gallery</button>
                    </div>
                    <p class="para-text" id="p6-txt">From Leicester Square, walk down to Charing Cross Road and then to the National Gallery. Here, you can see famous paintings by artists like Vincent van Gogh and Leonardo da Vinci. This museum was also a location in the James Bond movie Skyfall.</p>
                </div>

                <div class="para-block">
                    <div class="para-tools">
                        <button class="tool-btn" onclick="playText(this, 'p7-txt')"><i class="fas fa-volume-up"></i> Play</button>
                        <button class="tool-btn" onclick="showLocation('Palace')"><i class="fas fa-map-marker-alt"></i> Buckingham Palace</button>
                    </div>
                    <p class="para-text" id="p7-txt">Finally, go south on Charing Cross Road, past the underground station—which appears in Thor: The Dark World—and follow the Mall. At the end of the Mall, you’ll see Buckingham Palace, the home of the British royal family. The palace appears in several movies, such as The BFG and The King’s Speech.</p>
                </div>

                <button class="action-btn gold" id="btn-answer-q" onclick="openAnswerSection()">
                    <i class="fas fa-edit"></i> Answer the pre-reading questions
                </button>
            </div>
        </div>

        <div class="right-panel">
            <div id="poster-marquee-container">
                <div class="marquee-content" id="marquee-content">
                    </div>
            </div>

            <div id="map-wrapper">
                <div id="map"></div>
                <div id="map-overlay-container"></div>
            </div>
            
            <div id="right-interaction-overlay">
                
                <div id="step-type" class="interaction-step">
                    <div class="step-title">1. What type of text is this?</div>
                    
                    <div class="type-card" onclick="checkType(this, false, 'Narrative. Tells a story with characters and plot.')">
                        <div class="type-header">
                            <span class="type-name">Narrative (记叙文)</span>
                            <div class="mini-tts-btn" onclick="event.stopPropagation(); azureSpeak('Narrative. Tells a story with characters and plot.')"><i class="fas fa-volume-up"></i></div>
                        </div>
                        <div class="type-def">Tells a story with characters and plot.</div>
                    </div>

                    <div class="type-card" onclick="checkType(this, false, 'Argumentative. Gives an opinion to agree or disagree.')">
                        <div class="type-header">
                            <span class="type-name">Argumentative (议论文)</span>
                            <div class="mini-tts-btn" onclick="event.stopPropagation(); azureSpeak('Argumentative. Gives an opinion to agree or disagree.')"><i class="fas fa-volume-up"></i></div>
                        </div>
                        <div class="type-def">Gives an opinion to agree or disagree.</div>
                    </div>

                    <div class="type-card" onclick="checkType(this, true, 'Correct! Expository. Gives facts, information, or instructions.')">
                        <div class="type-header">
                            <span class="type-name">Expository (说明文)</span>
                            <div class="mini-tts-btn" onclick="event.stopPropagation(); azureSpeak('Expository. Gives facts, information, or instructions.')"><i class="fas fa-volume-up"></i></div>
                        </div>
                        <div class="type-def">Gives facts, information, or instructions.</div>
                    </div>

                    <button id="btn-to-main" class="action-btn" style="display:none; width:100%; margin-top:20px;" onclick="goToMainIdea()">
                        Next Question <i class="fas fa-arrow-right"></i>
                    </button>
                </div>

                <div id="step-main-idea" class="interaction-step">
                    <div class="step-title">2. What is the main idea?</div>
                    <div class="step-subtitle">Read the first paragraph again. What is the text mainly about?</div>
                    
                    <div class="quiz-item">
                        <div class="quiz-opts">
                            <div class="q-opt" onclick="checkMainIdea(this, false)">A. A history of the British Royal Family.</div>
                            <div class="q-opt" onclick="checkMainIdea(this, true)">B. A guide to famous movie locations in London.</div>
                            <div class="q-opt" onclick="checkMainIdea(this, false)">C. An introduction to William Shakespeare's plays.</div>
                        </div>
                    </div>

                    <button id="btn-to-post" class="action-btn" style="display:none; width:100%; margin-top:20px;" onclick="goToPostReading()">
                        Proceed to Post-Reading Analysis <i class="fas fa-arrow-right"></i>
                    </button>
                </div>

                <div id="step-post" class="interaction-step">
                    <div class="step-title">Post-Reading Analysis</div>
                    
                    <div class="quiz-item">
                        <div class="quiz-q">1. Which word in the title shows this is a guide?</div>
                        <div class="quiz-opts">
                            <div class="q-opt" onclick="checkQuiz(this, false)">Movie-Goer's</div>
                            <div class="q-opt" onclick="checkQuiz(this, true)">Guide</div>
                            <div class="q-opt" onclick="checkQuiz(this, false)">London</div>
                        </div>
                    </div>

                    <div class="quiz-item">
                        <div class="quiz-q">2. Who is this text written for?</div>
                        <div class="quiz-opts">
                            <div class="q-opt" onclick="checkQuiz(this, false)">History Students</div>
                            <div class="q-opt" onclick="checkQuiz(this, true)">Movie Lovers / Tourists</div>
                        </div>
                    </div>

                    <div class="quiz-item">
                        <div class="quiz-q">3. Imagine writing a guide for food lovers visiting Chengdu. Choose the best title:</div>
                        <div class="quiz-opts">
                            <div class="q-opt" onclick="checkQuiz(this, false)">My Trip to Chengdu</div>
                            <div class="q-opt" onclick="checkQuiz(this, true, true)">A Food Lover's Guide to Chengdu</div>
                            <div class="q-opt" onclick="checkQuiz(this, false)">Why Chengdu Food is Spicy</div>
                        </div>
                    </div>

                    <div id="final-success-msg" style="display:none; text-align:center; margin-top:30px;">
                        <h3 style="color:#2ecc71;">Excellent!</h3>
                        <p>You have successfully analyzed the text structure and audience.</p>
                        <button class="action-btn" onclick="alert('Proceed to Page 03 for Intensive Reading.')">Finish First Reading</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // --- 1. Poster Marquee Init ---
        const posterFiles = [
            "poster_skyfall.jpg", "poster_harry_potter.jpg", "poster_paddington.jpg", 
            "poster_notting_hill.jpg", "poster_kingsman.jpg", "poster_sherlock.jpg", 
            "poster_love_actually.jpg", "poster_bridget_jones.jpg", "poster_spiderman.jpg", 
            "poster_mission_impossible.jpg", "poster_fast_furious.jpg", "poster_dark_knight.jpg", 
            "poster_dr_strange.jpg", "poster_fantastic_beasts.jpg", "poster_mary_poppins.jpg"
        ];
        
        function initMarquee() {
            const container = document.getElementById('marquee-content');
            // Duplicate multiple times for smooth scroll
            const allImages = [...posterFiles, ...posterFiles, ...posterFiles];
            
            allImages.forEach(src => {
                const img = document.createElement('img');
                img.className = 'poster-img';
                img.src = src; 
                img.alt = src;
                // Auto-fallback to text image if file not found
                img.onerror = function() {
                    const cleanName = src.replace('poster_', '').replace('.jpg', '').replace(/_/g, ' ');
                    this.src = `https://via.placeholder.com/200x300/222/D4AF37?text=${encodeURIComponent(cleanName)}`;
                    this.onerror = null;
                };
                container.appendChild(img);
            });
        }
        initMarquee();

        // --- 2. Map Init ---
        const map = L.map('map', {zoomControl: false}).setView([51.508, -0.128], 14);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CartoDB', maxZoom: 19
        }).addTo(map);

        const locations = {
            "Museum": { lat: 51.5122, lng: -0.1225, name: "London Film Museum" },
            "Garden": { lat: 51.5117, lng: -0.1230, name: "Covent Garden" },
            "Sheekey": { lat: 51.5110, lng: -0.1260, name: "J. Sheekey" },
            "Leicester": { lat: 51.5104, lng: -0.1301, name: "Leicester Square" },
            "Gallery": { lat: 51.5089, lng: -0.1283, name: "The National Gallery" },
            "Palace": { lat: 51.5014, lng: -0.1419, name: "Buckingham Palace" }
        };
        let activeMarkers = {};

        function showLocation(key) {
            const loc = locations[key];
            map.flyTo([loc.lat, loc.lng], 16, {duration: 1.5});
            if (!activeMarkers[key]) {
                const marker = L.marker([loc.lat, loc.lng]).addTo(map).bindPopup(`<b>${loc.name}</b>`);
                activeMarkers[key] = marker;
                setTimeout(() => marker.openPopup(), 1000);
            } else {
                setTimeout(() => activeMarkers[key].openPopup(), 1000);
            }
        }

        // --- 3. Interaction Logic ---
        function startReading() {
            document.getElementById('btn-start-read').style.display = 'none';
            // Move Pre-questions to map overlay
            const qBox = document.getElementById('pre-questions-box');
            const mapOverlay = document.getElementById('map-overlay-container');
            qBox.classList.add('moved');
            mapOverlay.appendChild(qBox);
            
            const article = document.getElementById('article-container');
            article.style.display = 'block';
            anime({ targets: article, opacity: [0, 1], translateY: [20, 0], duration: 800 });
        }

        function openAnswerSection() {
            // Highlight P1
            const p1 = document.getElementById('para-1');
            p1.classList.add('highlight-topic');
            p1.scrollIntoView({ behavior: 'smooth', block: 'center' });

            // Open Overlay
            const overlay = document.getElementById('right-interaction-overlay');
            overlay.style.display = 'flex';
            
            const stepType = document.getElementById('step-type');
            stepType.classList.add('active');

            // Hide bottom overlay to prevent clutter
            document.getElementById('pre-questions-box').style.display = 'none';
            document.getElementById('btn-answer-q').style.display = 'none';

            azureSpeak("Now, let's answer the pre-reading questions. First, what type of text is this?");
        }

        // Step 1: Check Type
        function checkType(card, isCorrect, speechText) {
            const parent = card.parentElement;
            parent.querySelectorAll('.type-card').forEach(c => c.classList.remove('correct', 'wrong'));

            if (isCorrect) {
                card.classList.add('correct');
                document.getElementById('btn-to-main').style.display = 'block';
            } else {
                card.classList.add('wrong');
            }
            azureSpeak(speechText);
        }

        function goToMainIdea() {
            document.getElementById('step-type').style.display = 'none';
            const stepMain = document.getElementById('step-main-idea');
            stepMain.classList.add('active');
            azureSpeak("Second question: What is the main idea of the text?");
        }

        // Step 2: Check Main Idea
        function checkMainIdea(btn, isCorrect) {
            const parent = btn.parentElement;
            parent.querySelectorAll('.q-opt').forEach(c => c.classList.remove('correct', 'wrong'));
            
            if (isCorrect) {
                btn.classList.add('correct');
                document.getElementById('btn-to-post').style.display = 'block';
                azureSpeak("Correct. It is a guide to movie locations.");
            } else {
                btn.classList.add('wrong');
                azureSpeak("Not quite. Look at the first paragraph again.");
            }
        }

        function goToPostReading() {
            document.getElementById('step-main-idea').style.display = 'none';
            const stepPost = document.getElementById('step-post');
            stepPost.classList.add('active');
            azureSpeak("Great. Now let's analyze the title and audience.");
        }

        // Step 3: Post Reading Quiz
        function checkQuiz(btn, isCorrect, isFinal) {
            const parent = btn.parentElement;
            const opts = parent.querySelectorAll('.q-opt');
            opts.forEach(o => o.classList.remove('correct', 'wrong'));
            
            if (isCorrect) {
                btn.classList.add('correct');
                azureSpeak("Correct.");
                if (isFinal) {
                    document.getElementById('final-success-msg').style.display = 'block';
                }
            } else {
                btn.classList.add('wrong');
                azureSpeak("Try again.");
            }
        }

        // --- 4. Azure TTS ---
        const speechKey = "DKRXk8ueSfo5NdIOMqFRTCAfpeGDezJ3Snf5K8gGgtyqxiWdugLzJQQJ99BLACHYHv6XJ3w3AAAYACOGUYP9";
        const speechRegion = "eastus2";
        let synthesizer;
        let currentBtn = null;

        function azureSpeak(text) {
            const config = SpeechSDK.SpeechConfig.fromSubscription(speechKey, speechRegion);
            config.speechSynthesisVoiceName = "en-GB-RyanNeural";
            const synth = new SpeechSDK.SpeechSynthesizer(config);
            synth.speakTextAsync(text, () => synth.close());
        }

        function playText(btn, txtId) {
            if (synthesizer) { synthesizer.close(); synthesizer = undefined; }
            if (currentBtn) { currentBtn.innerHTML = '<i class="fas fa-volume-up"></i> Play'; currentBtn.classList.remove('playing'); }
            
            if (currentBtn === btn) { currentBtn = null; return; }

            const text = document.getElementById(txtId).innerText;
            const config = SpeechSDK.SpeechConfig.fromSubscription(speechKey, speechRegion);
            config.speechSynthesisVoiceName = "en-GB-RyanNeural";
            const audioConfig = SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
            synthesizer = new SpeechSDK.SpeechSynthesizer(config, audioConfig);

            btn.classList.add('playing');
            btn.innerHTML = '<i class="fas fa-stop"></i> Stop';
            currentBtn = btn;

            synthesizer.speakTextAsync(text, 
                () => { btn.classList.remove('playing'); btn.innerHTML = '<i class="fas fa-volume-up"></i> Play'; synthesizer.close(); currentBtn = null; },
                err => { console.error(err); btn.classList.remove('playing'); btn.innerHTML = '<i class="fas fa-volume-up"></i> Play'; synthesizer.close(); currentBtn = null; }
            );
        }
    </script>
</body>
</html>