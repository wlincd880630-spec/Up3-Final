<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page 03: Guided Tour</title>
    <script src="https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle-min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Nunito:wght@400;700&family=Playfair+Display:ital,wght@0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary-red: #C8102E;
            --royal-blue: #003399;
            --gold: #D4AF37;
            --text-bg: #000000;
        }

        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: 'Nunito', sans-serif; overflow: hidden; background: #000; }

        .main-container { display: grid; grid-template-columns: 40% 60%; height: 100vh; }

        /* 左侧面板 */
        .left-panel {
            background: var(--text-bg); padding: 40px; display: flex; flex-direction: column;
            position: relative; border-right: 1px solid #333; overflow: hidden; z-index: 10;
        }

        .title-container { 
            border-bottom: 2px solid var(--primary-red); padding-bottom: 20px; margin-bottom: 20px; flex-shrink: 0;
        }
        .lesson-title { 
            font-family: 'Bebas Neue', sans-serif; font-size: 3rem; line-height: 1; color: #fff; letter-spacing: 2px; 
        }

        /* 课前问题框 (左侧初始状态) */
        #pre-questions-box {
            background: rgba(255,255,255,0.1); border: 1px solid #444; border-radius: 8px;
            padding: 20px; margin-bottom: 20px; color: #fff; flex-shrink: 0;
            transition: all 0.5s ease;
        }
        #pre-questions-box h3 { margin-top: 0; color: var(--gold); font-size: 1.2rem; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        
        .q-list { display: flex; flex-direction: column; gap: 15px; }
        .q-item { border-left: 2px solid var(--royal-blue); padding-left: 10px; }
        .q-text { font-size: 1rem; color: #fff; font-weight: bold; margin-bottom: 5px; }
        .q-hint { font-size: 0.9rem; color: #aaa; font-style: italic; }
        .mini-tts { cursor:pointer; color: #888; margin-left: 8px; transition: 0.2s; }
        .mini-tts:hover { color: #fff; }

        /* 主按钮 */
        .main-action-btn {
            background: var(--primary-red); color: #fff; border: none; padding: 12px 30px;
            font-size: 1.1rem; border-radius: 30px; cursor: pointer; transition: 0.3s;
            font-family: 'Nunito', sans-serif; align-self: flex-start; margin-bottom: 20px;
        }
        .main-action-btn:hover { background: #fff; color: #000; transform: scale(1.05); }
        
        .review-btn { background: var(--gold); color: #000; width: 100%; margin-top: 20px; margin-bottom: 50px; }

        /* 文章容器 */
        #article-container {
            flex: 1; overflow-y: auto; padding-right: 15px; display: none; opacity: 0;
        }
        #article-container::-webkit-scrollbar { width: 6px; }
        #article-container::-webkit-scrollbar-track { background: #111; }
        #article-container::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        .para-block {
            margin-bottom: 30px; border-left: 1px solid #333; padding-left: 15px;
            transition: 0.3s;
        }
        .para-block:hover { border-left-color: var(--gold); }

        .para-tools {
            display: flex; gap: 8px; margin-bottom: 8px; flex-wrap: wrap;
        }
        .tool-btn {
            background: #222; border: 1px solid #444; color: #ccc; 
            height: 32px; min-width: 90px; padding: 0 15px;
            border-radius: 16px; cursor: pointer; font-size: 0.85rem;
            display: inline-flex; align-items: center; justify-content: center; gap: 6px; 
            transition: 0.2s; white-space: nowrap;
        }
        .tool-btn:hover { background: var(--gold); color: #000; border-color: var(--gold); }
        .tool-btn.playing { background: var(--primary-red); color: #fff; border-color: var(--primary-red); }

        .para-text {
            font-family: 'Playfair Display', serif; font-size: 1.2rem; line-height: 1.6; color: #ddd;
            text-align: justify; margin: 0;
        }

        /* --- 修正重点：Review Section (嵌入在左侧文章下方) --- */
        #review-section {
            display: none; 
            margin-top: 20px; margin-bottom: 50px; /* 底部留白方便滚动 */
            padding: 25px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--gold);
            border-radius: 12px;
            color: #fff;
        }
        
        .answer-content { 
            margin-top: 20px; display: none; 
            border-top: 1px solid #444; padding-top: 20px; 
            font-size: 1rem; line-height: 1.6;
        }
        
        .ans-btn { 
            margin-top: 20px; padding: 10px 30px; border-radius: 30px; 
            border:none; cursor: pointer; font-weight: bold;
            background: var(--royal-blue); color: #fff;
        }

        /* --- 右侧地图区域 --- */
        .right-panel { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; z-index: 1; }
        
        /* 地图底部问题框容器 */
        #map-overlay-container {
            position: absolute; bottom: 0; left: 0; right: 0; z-index: 1000;
            padding: 20px; pointer-events: none; display: flex; justify-content: center;
        }

        /* 移动到底部的问题框样式 (并排显示) */
        #pre-questions-box.moved-to-map {
            pointer-events: auto; background: rgba(0, 0, 0, 0.9);
            border-top: 2px solid var(--gold); border-radius: 12px 12px 0 0;
            padding: 20px; width: 95%; margin: 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }
        #pre-questions-box.moved-to-map .q-list { display: flex; flex-direction: row; gap: 30px; }
        #pre-questions-box.moved-to-map .q-item { flex: 1; border-left: none; border-top: 2px solid var(--royal-blue); padding-left: 0; padding-top: 10px; margin-bottom: 0; }
        #pre-questions-box.moved-to-map h3 { font-size: 1rem; margin-bottom: 10px; color: var(--gold); }
        #pre-questions-box.moved-to-map .q-text { font-size: 0.95rem; }
        #pre-questions-box.moved-to-map .q-hint { font-size: 0.85rem; }

        .simple-popup { font-weight: bold; font-size: 1.1rem; color: #333; text-align: center; padding: 5px; }

    </style>
</head>
<body>

    <div class="main-container">
        <div class="left-panel">
            <div class="title-container">
                <div class="lesson-title">A MOVIE-GOER’S GUIDE TO LONDON</div>
            </div>

            <div id="pre-questions-box">
                <h3><i class="fas fa-clipboard-list"></i> Pre-reading Questions</h3>
                <div class="q-list">
                    <div class="q-item">
                        <div class="q-text">1. If you want to introduce a famous place, what information should you include? <i class="fas fa-volume-up mini-tts" onclick="simpleSpeak('If you want to introduce a famous place, what information should you include? ')"></i></div>
                        <div class="q-hint">Think: What key details are mentioned about each place?</div>
                    </div>
                    <div class="q-item">
                        <div class="q-text">2. How do you know the order of the visit based on the passage?<i class="fas fa-volume-up mini-tts" onclick="simpleSpeak('How do you know the order of the visit based on the passage?')"></i></div>
                        <div class="q-hint">Look for words that show the order of the tour.</div>
                    </div>
                </div>
            </div>

            <button id="btn-show-article" class="main-action-btn" onclick="revealArticle()">
                <i class="fas fa-book-open"></i> Show Article
            </button>

            <div id="article-container">
                
                <div class="para-block">
                    <div class="para-tools">
                        <button class="tool-btn" onclick="playText(this, 'p1')"><i class="fas fa-volume-up"></i> Play</button>
                    </div>
                    <p class="para-text" id="p1">London has been the setting¹ for many popular movies—from James Bond to Harry Potter. So if you are visiting the UK’s capital, why not follow this walking tour and explore some interesting movie locations?</p>
                </div>

                <div class="para-block">
                    <div class="para-tools">
                        <button class="tool-btn" onclick="playText(this, 'p2')"><i class="fas fa-volume-up"></i> Play</button>
                        <button class="tool-btn" onclick="showLocation('Museum')"><i class="fas fa-map-marker-alt"></i> Film Museum</button>
                        <button class="tool-btn" onclick="showLocation('Garden')"><i class="fas fa-map-marker-alt"></i> Covent Garden</button>
                    </div>
                    <p class="para-text" id="p2">Start at the London Film Museum. Here, you can see a collection of items from many famous movies. The museum is near Covent Garden—a famous market. And while you’re there, you should check out some of the amazing street performers.</p>
                </div>

                <div class="para-block">
                    <div class="para-tools">
                        <button class="tool-btn" onclick="playText(this, 'p3')"><i class="fas fa-volume-up"></i> Play</button>
                        <button class="tool-btn" onclick="showLocation('Sheekey')"><i class="fas fa-map-marker-alt"></i> J. Sheekey</button>
                    </div>
                    <p class="para-text" id="p3">Next, walk down King Street, then along New Row to J. Sheekey. This restaurant is a great place to see TV and movie stars. And it’s not too expensive; you can get a great meal for under £25.</p>
                </div>

                <div class="para-block">
                    <div class="para-tools">
                        <button class="tool-btn" onclick="playText(this, 'p4')"><i class="fas fa-volume-up"></i> Play</button>
                        <button class="tool-btn" onclick="showLocation('Leicester')"><i class="fas fa-map-marker-alt"></i> Leicester Sq</button>
                    </div>
                    <p class="para-text" id="p4">Nearby is Leicester Square, known as London’s “Theatreland.” It is also home to the London Film Festival. Many famous movie premieres² are held in this area of the city. One of the exits of the Leicester Square underground station appears in the movie Harry Potter and the Half-Blood Prince.</p>
                </div>

                <div class="para-block">
                    <div class="para-tools">
                        <button class="tool-btn" onclick="playText(this, 'p5')"><i class="fas fa-volume-up"></i> Play</button>
                    </div>
                    <p class="para-text" id="p5">To get away from the crowds, you should spend some time in Leicester Square Gardens. Here, you’ll see a statue of William Shakespeare. Shakespeare wrote his most famous plays while he was living in London. Many of his plays, such as Macbeth, were later made into movies.</p>
                </div>

                <div class="para-block">
                    <div class="para-tools">
                        <button class="tool-btn" onclick="playText(this, 'p6')"><i class="fas fa-volume-up"></i> Play</button>
                        <button class="tool-btn" onclick="showLocation('Gallery')"><i class="fas fa-map-marker-alt"></i> National Gallery</button>
                    </div>
                    <p class="para-text" id="p6">From Leicester Square, walk down to Charing Cross Road and then to the National Gallery. Here, you can see famous paintings by artists like Vincent van Gogh and Leonardo da Vinci. This museum was also a location in the James Bond movie Skyfall.</p>
                </div>

                <div class="para-block">
                    <div class="para-tools">
                        <button class="tool-btn" onclick="playText(this, 'p7')"><i class="fas fa-volume-up"></i> Play</button>
                        <button class="tool-btn" onclick="showLocation('Palace')"><i class="fas fa-map-marker-alt"></i> Buckingham Palace</button>
                    </div>
                    <p class="para-text" id="p7">Finally, go south on Charing Cross Road, past the underground station—which appears in Thor: The Dark World—and follow the Mall. At the end of the Mall, you’ll see Buckingham Palace, the home of the British royal family. The palace appears in several movies, such as The BFG and The King’s Speech.</p>
                </div>

                <button class="main-action-btn review-btn" onclick="openReviewSection()">
                    <i class="fas fa-check-circle"></i> Finish & Review Questions
                </button>

                <div id="review-section">
                    <h2 style="color:var(--gold); margin-top:0;">Pre-reading Review</h2>
                    <p style="font-size:1.1rem; line-height:1.6;">Now that you have finished reading, think about the two questions again. Can you find the answers?</p>
                    
                    <button class="ans-btn" onclick="revealAnswers()" id="btn-reveal">Show Key Answers</button>

                    <div id="ans-hidden-content" class="answer-content">
                        <div style="margin-bottom:20px;">
                            <strong style="color:var(--royal-blue); display:block; margin-bottom:5px;">1. Information to introduce:</strong>
                            Name, Location, What to see (Features), Practical Info (e.g. Price, Food), Fun Facts (Movies).
                        </div>
                        <div>
                            <strong style="color:var(--royal-blue); display:block; margin-bottom:5px;">2. Tour Sequence Clues:</strong>
                            Look for signal words: <em>Start at, Next, Nearby, From... walk down..., Finally.</em>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div class="right-panel">
            <div id="map"></div>
            <div id="map-overlay-container"></div>
        </div>
    </div>

    <script>
        // --- 1. 地图初始化 ---
        const map = L.map('map', {zoomControl: false}).setView([51.508, -0.128], 14);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CartoDB', maxZoom: 19
        }).addTo(map);

        const locations = {
            "Museum": { lat: 51.5122, lng: -0.1225, name: "London Film Museum" },
            "Garden": { lat: 51.5117, lng: -0.1230, name: "Covent Garden" },
            "Sheekey": { lat: 51.5110, lng: -0.1260, name: "J. Sheekey" },
            "Leicester": { lat: 51.5104, lng: -0.1301, name: "Leicester Square" },
            "Gallery": { lat: 51.5089, lng: -0.1283, name: "The National Gallery" },
            "Palace": { lat: 51.5014, lng: -0.1419, name: "Buckingham Palace" }
        };

        let activeMarkers = {};

        // --- 2. 交互逻辑 ---
        
        function revealArticle() {
            document.getElementById('btn-show-article').style.display = 'none';
            const artContainer = document.getElementById('article-container');
            artContainer.style.display = 'block';
            anime({ targets: artContainer, opacity: [0, 1], translateY: [20, 0], duration: 800 });

            const qBox = document.getElementById('pre-questions-box');
            const mapOverlay = document.getElementById('map-overlay-container');
            qBox.classList.add('moved-to-map'); 
            mapOverlay.appendChild(qBox);
        }

        function showLocation(key) {
            const loc = locations[key];
            if (!loc) return;
            map.flyTo([loc.lat, loc.lng], 16, {duration: 1.5});

            if (!activeMarkers[key]) {
                const marker = L.marker([loc.lat, loc.lng]).addTo(map);
                const popupContent = `<div class="simple-popup">${loc.name}</div>`;
                marker.bindPopup(popupContent);
                activeMarkers[key] = marker;
                setTimeout(() => marker.openPopup(), 1000);
            } else {
                setTimeout(() => activeMarkers[key].openPopup(), 1000);
            }
        }

        // --- 3. 嵌入式 Review 逻辑 ---
        function openReviewSection() {
            // 显示 Review 区域
            const reviewSec = document.getElementById('review-section');
            reviewSec.style.display = 'block';
            
            // 隐藏 "Finish & Review" 按钮本身，因为它已经点击过了
            document.querySelector('.review-btn').style.display = 'none';

            // 动画淡入
            anime({ targets: reviewSec, opacity: [0, 1], translateY: [20, 0], duration: 500 });
            
            // 自动滚动到底部
            setTimeout(() => {
                reviewSec.scrollIntoView({ behavior: 'smooth', block: 'end' });
            }, 100);
        }

        function revealAnswers() {
            document.getElementById('ans-hidden-content').style.display = 'block';
            document.getElementById('btn-reveal').style.display = 'none';
            anime({ targets: '#ans-hidden-content', opacity: [0, 1], translateY: [10, 0] });
        }

        // --- 4. 音频逻辑 ---
        const speechKey = "DKRXk8ueSfo5NdIOMqFRTCAfpeGDezJ3Snf5K8gGgtyqxiWdugLzJQQJ99BLACHYHv6XJ3w3AAAYACOGUYP9";
        const speechRegion = "eastus2";
        let synthesizer;
        let currentBtn = null;

        function playText(btn, pId) {
            if (synthesizer) {
                synthesizer.close();
                synthesizer = undefined;
            }
            if (currentBtn === btn) {
                btn.classList.remove('playing');
                btn.innerHTML = '<i class="fas fa-volume-up"></i> Play';
                currentBtn = null;
                return;
            }
            if (currentBtn) {
                currentBtn.classList.remove('playing');
                currentBtn.innerHTML = '<i class="fas fa-volume-up"></i> Play';
            }

            const textToRead = document.getElementById(pId).innerText;
            const speechConfig = SpeechSDK.SpeechConfig.fromSubscription(speechKey, speechRegion);
            speechConfig.speechSynthesisVoiceName = "en-GB-RyanNeural"; 
            const audioConfig = SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
            
            synthesizer = new SpeechSDK.SpeechSynthesizer(speechConfig, audioConfig);
            
            currentBtn = btn;
            btn.classList.add('playing');
            btn.innerHTML = '<i class="fas fa-stop"></i> Stop';

            synthesizer.speakTextAsync(
                textToRead,
                result => {
                    btn.classList.remove('playing');
                    btn.innerHTML = '<i class="fas fa-volume-up"></i> Play';
                    synthesizer.close();
                    synthesizer = undefined;
                    currentBtn = null;
                },
                err => {
                    console.error(err);
                    btn.classList.remove('playing');
                    btn.innerHTML = '<i class="fas fa-volume-up"></i> Play';
                    synthesizer.close();
                    currentBtn = null;
                }
            );
        }

        function simpleSpeak(text) {
            const config = SpeechSDK.SpeechConfig.fromSubscription(speechKey, speechRegion);
            config.speechSynthesisVoiceName = "en-GB-RyanNeural";
            const synth = new SpeechSDK.SpeechSynthesizer(config);
            synth.speakTextAsync(text, () => synth.close());
        }

    </script>
</body>
</html>