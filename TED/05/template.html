<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ config.title }}</title>
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: {{ config.theme.primary | default('#4F46E5') }};
            --accent: {{ config.theme.accent | default('#F59E0B') }};
            --bg-start: {{ config.theme.bg_start | default('#EEF2FF') }};
            --bg-end: {{ config.theme.bg_end | default('#E0E7FF') }};
            --text-main: #1e293b;
            --text-sub: #64748b;
            --card-bg: rgba(255, 255, 255, 0.95);
            --radius-xl: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; font-family: 'Inter', 'Noto Sans SC', sans-serif; 
            background: linear-gradient(135deg, var(--bg-start), var(--bg-end));
            color: var(--text-main); 
            height: 100vh; height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* Header */
        .header {
            background: rgba(255,255,255,0.8); backdrop-filter: blur(12px);
            padding: 0 20px; height: 60px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(0,0,0,0.05); z-index: 100; flex-shrink: 0;
        }
        .brand { font-weight: 800; font-size: 1.1rem; color: var(--primary); }
        .score-pill { background: white; color: var(--primary); padding: 4px 12px; border-radius: 20px; font-weight: 800; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* Page */
        .page { display: none; height: 100%; flex-direction: column; overflow-y: auto; padding: 20px; animation: fadeIn 0.3s ease; }
        .page.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .container { width: 100%; max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; flex: 1; height: 100%; }

        /* Card */
        .card { 
            background: var(--card-bg); border-radius: var(--radius-xl); padding: 25px; 
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.1); border: 1px solid rgba(255,255,255,0.5);
            display: flex; flex-direction: column;
        }

        /* Rules */
        .rules-box { background: #f8fafc; padding: 15px; border-radius: 12px; margin: 20px 0; text-align: left; border: 1px dashed #cbd5e1; }
        .rule-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.95rem; font-weight: 500; }
        .rule-pts { font-weight: 800; color: var(--accent); background: #fff7ed; padding: 2px 8px; border-radius: 4px; }

        /* Buttons */
        .btn { 
            background: var(--primary); color: white; border: none; 
            padding: 12px 24px; border-radius: 10px; font-weight: 700; cursor: pointer; 
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 1rem; 
            transition: 0.2s; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.2);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(79, 70, 229, 0.3); }
        .btn:active { transform: scale(0.98); }
        .btn-outline { background: white; border: 2px solid var(--primary); color: var(--primary); box-shadow: none; }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* VT Layout */
        .vt-layout { 
            display: flex; flex-direction: column; gap: 0; width: 100%; height: 100%; min-height: 500px;
            background: #000; border-radius: var(--radius-xl); overflow: hidden; box-shadow: 0 20px 50px -10px rgba(0,0,0,0.3);
        }
        @media (min-width: 900px) { 
            .vt-layout { flex-direction: row; height: 75vh; height: 75dvh; max-height: 800px; align-items: stretch; } 
            .vt-video-col { flex: 1; position: relative; display: flex; flex-direction: column; min-width: 0; }
            .vt-sub-box { width: 320px; flex-shrink: 0; border-left: 1px solid #333; height: auto; }
        }
        .vt-video-col { flex: 1; position: relative; background: #000; display: flex; align-items: center; justify-content: center; }
        video { width: 100%; height: 100%; object-fit: contain; }
        .vt-sub-box { background: white; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        
        /* Subtitles */
        .sub-list { flex: 1; overflow-y: auto; padding: 15px; scroll-behavior: smooth; }
        .sub-line { padding: 8px 10px; margin-bottom: 5px; border-radius: 6px; color: #64748b; font-size: 0.95rem; line-height: 1.5; transition: 0.2s; }
        .sub-line:hover { background: #f1f5f9; }
        .sub-line.active { background: #eff6ff; color: var(--primary); font-weight: 700; border-left: 3px solid var(--primary); }
        .w-click { cursor: pointer; padding: 0 2px; border-radius: 3px; }
        .w-click:hover { background: var(--accent); color: white; }

        /* HUD */
        .hud { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(4px); color: #FFF; 
            padding: 10px 25px; border-radius: 12px; font-weight: 600; font-size: 1rem; line-height: 1.4;
            z-index: 30; pointer-events: none; border: 1px solid rgba(255,255,255,0.15);
            text-align: center; width: auto; max-width: 90%; white-space: normal; display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* Controls */
        .controls { 
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); 
            padding: 15px 20px; display: flex; gap: 15px; align-items: center; z-index: 30;
        }
        input[type=range] { flex: 1; height: 4px; border-radius: 2px; accent-color: #64748b; cursor: not-allowed; width: 100%; opacity: 0.6; }
        .spd-sel { background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 0.85rem; cursor: pointer; }
        .spd-sel option { color: black; }

        /* Overlay */
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); z-index: 50; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        .q-card { background: white; width: 100%; max-width: 600px; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); overflow-y: auto; max-height: 90vh; }
        
        /* Feedback Box */
        .feedback-box {
            margin-top: 20px; padding: 20px; border-radius: 12px; text-align: left;
            display: none; animation: slideUp 0.3s;
        }
        .feedback-box.correct { background: #F0FDF4; border: 1px solid #BBF7D0; color: #166534; }
        .feedback-box.wrong { background: #FEF2F2; border: 1px solid #FECACA; color: #991B1B; }
        .feedback-title { font-weight: 800; font-size: 1.1rem; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .feedback-text { font-size: 0.95rem; line-height: 1.5; color: #374151; }

        /* Options (Big Buttons) */
        .opt-btn {
            display: block; width: 100%; text-align: left; padding: 15px; 
            margin-bottom: 10px; border: 2px solid #e2e8f0; border-radius: 10px;
            background: white; font-size: 1rem; cursor: pointer; transition: 0.2s;
        }
        .opt-btn:hover:not(:disabled) { border-color: var(--primary); background: #f8fafc; }
        .opt-btn.sel-correct { background: #dcfce7; border-color: #22c55e; color: #14532d; }
        .opt-btn.sel-wrong { background: #fee2e2; border-color: #ef4444; color: #7f1d1d; }
        .opt-btn:disabled { cursor: default; opacity: 0.9; }

        /* Review Styles */
        .review-list { text-align: left; max-height: 60vh; overflow-y: auto; margin: 20px 0; padding-right: 5px; }
        .review-item { background: #F8FAFC; border: 1px solid #E2E8F0; padding: 15px; border-radius: 10px; margin-bottom: 12px; }
        .review-item.correct { border-left: 4px solid #22C55E; }
        .review-item.wrong { border-left: 4px solid #EF4444; }
        .review-q { font-weight: bold; margin-bottom: 5px; font-size: 0.95rem; }
        .review-ans { font-size: 0.9rem; color: #64748b; }
        .review-exp { background: #EEF2FF; color: var(--primary); padding: 8px; border-radius: 6px; font-size: 0.85rem; margin-top: 8px; }

        /* Vocab */
        .vocab-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .flashcard { 
            background: white; border-radius: 14px; padding: 20px; text-align: center;
            border: 2px solid transparent; cursor: pointer; height: 160px; 
            display: flex; flex-direction: column; justify-content: center; position: relative; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.03); transition: 0.2s;
        }
        .flashcard:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .flashcard.learned { background: #F0FDF4; border-color: #86EFAC; }
        .flashcard .tag { position: absolute; top: 10px; left: 10px; font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; background: #f1f5f9; text-transform: uppercase; color: #64748b; font-weight: bold; }
        .flashcard .save-icon { position: absolute; top: 10px; right: 10px; color: #cbd5e1; font-size: 1.2rem; }
        .flashcard .save-icon.saved { color: var(--accent); }

        /* Report */
        .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 30px 0; }
        .report-item { background: white; padding: 20px; border-radius: 16px; border: 1px solid #e2e8f0; }
        .report-val { font-size: 2rem; font-weight: 800; color: var(--primary); display: block; }
        .report-lbl { font-size: 0.85rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }

        /* Modals */
        .modal-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: white; width: 100%; max-width: 500px; border-radius: 20px; padding: 30px; position: relative; max-height: 90vh; overflow-y: auto; }
        .blur-txt { filter: blur(6px); opacity: 0.5; transition: 0.2s; cursor: pointer; }
        .blur-txt.show { filter: none; opacity: 1; }

        /* DeepSeek Popup */
        #ds-pop { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: white; 
            border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); 
            z-index: 3000; display: none; overflow: hidden; border: 1px solid #e2e8f0;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .ds-head { background: var(--primary); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .ds-body { padding: 20px; max-height: 300px; overflow-y: auto; }
        .ds-word { font-size: 1.5rem; font-weight: 800; color: var(--text-main); margin-bottom: 5px; }
        .ds-cn { font-size: 1.1rem; color: var(--text-sub); margin-bottom: 10px; }
        .ds-en { font-style: italic; color: #475569; margin-bottom: 15px; border-left: 3px solid var(--accent); padding-left: 10px; }
        .ds-ex { background: #f8fafc; padding: 10px; border-radius: 8px; font-size: 0.9rem; color: var(--primary); }
    </style>
</head>
<body>

<div class="header">
    <div class="brand"><i class="fas fa-layer-group"></i> {{ config.title }}</div>
    <div style="display:flex; gap:10px;">
        <div class="score-pill"><i class="fas fa-star" style="color:var(--accent)"></i> <span id="u-score">0</span></div>
        <button class="btn btn-sm btn-outline" onclick="saveState(true)"><i class="fas fa-save"></i> Save</button>
    </div>
</div>

<div id="p1" class="page active">
    <div class="container" style="justify-content:center; align-items:center;">
        <div class="card" style="width: 100%; max-width: 600px; text-align: center;">
            <div style="font-size:3.5rem; color:var(--primary); margin-bottom:15px;"><i class="fas fa-rocket"></i></div>
            <h1 style="font-size: 2rem; margin-bottom: 10px;">Mission Start</h1>
            <p style="color:var(--text-sub); font-size: 1.1rem;">Ready to master this topic?</p>
            
            <div class="rules-box">
                <div class="rule-item"><span><i class="fas fa-book-open"></i> Study Vocabulary</span><span class="rule-pts">+2 pts</span></div>
                <div class="rule-item"><span><i class="fas fa-gamepad"></i> Vocab Quiz</span><span class="rule-pts">+/- 1 pt</span></div>
                <div class="rule-item"><span><i class="fas fa-eye"></i> Video Questions</span><span class="rule-pts">+5 pts</span></div>
            </div>

            <input type="text" id="username" placeholder="Enter Your Name" style="width:100%; padding:16px; border:2px solid #e2e8f0; border-radius:12px; font-size:1.1rem; text-align:center; margin-bottom:25px; outline-color: var(--primary);">
            <button class="btn" style="width:100%; font-size:1.2rem; padding:16px;" onclick="startApp()">Start Adventure <i class="fas fa-arrow-right"></i></button>
            <div style="margin-top:15px;"><button id="resume-btn" class="btn btn-sm btn-outline" style="display:none;" onclick="resumeApp()">Resume Last Session</button></div>
        </div>
    </div>
</div>

<div id="p2" class="page">
    <div class="container">
        <div class="card" style="height:100%;">
            <h2 style="margin-top:0;">Topic Overview</h2>
            <div style="flex-shrink:0; position:relative; height:240px; background:#f1f5f9; border-radius:16px; overflow:hidden; margin-bottom:25px;">
                {% for img in images %}
                <div class="slide-img" style="display:{{ 'block' if loop.first else 'none' }}; width:100%; height:100%;">
                    <img src="{{ img.src }}" style="width:100%; height:100%; object-fit:cover;">
                    <div style="position:absolute; bottom:0; width:100%; background:linear-gradient(transparent, rgba(0,0,0,0.8)); color:white; padding:15px 20px; font-size:0.9rem;">{{ img.prompt }}</div>
                </div>
                {% endfor %}
                <button onclick="slide(-1)" style="position:absolute; top:50%; left:15px; transform:translateY(-50%); background:rgba(255,255,255,0.9); width:40px; height:40px; border-radius:50%; border:none; cursor:pointer;">‚ùÆ</button>
                <button onclick="slide(1)" style="position:absolute; top:50%; right:15px; transform:translateY(-50%); background:rgba(255,255,255,0.9); width:40px; height:40px; border-radius:50%; border:none; cursor:pointer;">‚ùØ</button>
            </div>
            <div style="flex:1; overflow-y:auto; padding-right:10px; font-size: 1.05rem; line-height: 1.8; color: #334155;">
                {% for p in reading %}
                <p style="margin-bottom:15px;">{{ p.text }} <i class="fas fa-volume-up" style="color:var(--primary); cursor:pointer; margin-left:5px; opacity:0.6;" onclick="speak(`{{ p.text }}`)"></i></p>
                {% endfor %}
            </div>
            <div style="text-align:right; margin-top:20px;"><button class="btn" onclick="toPage('p3')">Next Step <i class="fas fa-arrow-right"></i></button></div>
        </div>
    </div>
</div>

<div id="p3" class="page">
    <div class="container">
        <div class="card">
            <h2 style="margin:0 0 25px 0;">Vocabulary List</h2>
            <div class="vocab-grid">
                {% for v in vocab %}
                <div class="flashcard" onclick="openVocab({{ loop.index0 }})" id="vc-{{ loop.index0 }}">
                    <div class="tag">{{ v.type }}</div>
                    <i class="fas fa-bookmark save-icon" id="bm-{{ loop.index0 }}" onclick="toggleSave(event, {{ loop.index0 }})"></i>
                    <div style="font-size:1.2rem; font-weight:800; margin-top:15px; color:var(--text-main);">{{ v.w }}</div>
                    <div style="color:var(--text-sub); font-size:0.85rem; margin-top:5px;">{{ v.en_def[:25] }}...</div>
                </div>
                {% endfor %}
            </div>
            <div style="text-align:center; margin-top:40px;"><button class="btn" onclick="toPage('p4')">Start Quiz <i class="fas fa-gamepad"></i></button></div>
        </div>
    </div>
</div>

<div id="p4" class="page">
    <div class="container" style="justify-content:center;">
        <div class="card" style="text-align:center; max-width:600px; margin:0 auto;">
            <div id="qz-setup">
                <h2>Choose Challenge Level</h2>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:25px;">
                    {% for t in config.quizTiers %}
                    <button class="btn btn-outline" style="padding:20px; border-radius: 12px;" onclick="startQuiz({{ t.percent }}, {{ t.base }})">
                        <div style="font-size:1.2rem; font-weight:800;">{{ t.label }}</div>
                        <div style="font-size:0.9rem; opacity: 0.8;">Base: {{ t.base }} pts</div>
                    </button>
                    {% endfor %}
                </div>
            </div>
            <div id="qz-run" style="display:none; text-align:left;">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <strong>Q: <span id="q-idx">1</span></strong>
                    <span style="color:var(--accent); font-weight:bold;">Score: <span id="q-score">0</span></span>
                </div>
                <div id="q-content"></div>
                <div id="q-fb" style="display:none; background:#F0F9FF; padding:20px; border-radius:12px; margin-top:20px; border: 1px solid #BAE6FD;"></div>
                <button id="q-nxt" class="btn" style="width:100%; margin-top:20px; display:none;" onclick="nextQ()">Next (5s)</button>
            </div>
        </div>
    </div>
</div>

<div id="p5" class="page">
    <div class="container" style="max-width:1400px;">
        <div class="vt-layout">
            <div class="vt-video-col">
                <div id="hud1" class="hud">Loading Question...</div>
                <video id="vid1" src="{{ config.videoFile }}" playsinline></video>
                
                <div id="ol1" class="overlay">
                    <div class="q-card">
                        <h3 id="v1-q" style="color:var(--primary); margin-bottom: 20px;">Question</h3>
                        <div id="v1-opts" style="display:flex; flex-direction:column; gap:10px;"></div>
                        <div id="fb1" class="feedback-box"></div>
                        <div style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
                            <button class="btn btn-outline" id="rp1" onclick="replaySeg(1)"><i class="fas fa-undo"></i> Replay Segment</button>
                            <button class="btn" id="ct1" onclick="resume(1)" style="display:none;">Continue <i class="fas fa-play"></i></button>
                        </div>
                    </div>
                </div>
                
                <div id="rev1" class="overlay">
                    <div class="q-card" style="max-width: 700px; text-align: left;">
                        <h2 style="color:var(--primary); text-align: center;">Part 1 Review</h2>
                        <div id="rev1-list" class="review-list"></div>
                        <div style="text-align: center;"><button class="btn" onclick="toPage('p6')">Start Part 2 <i class="fas fa-arrow-right"></i></button></div>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn btn-sm btn-icon" style="background:white; color:black; border-radius:50%; width:32px; height:32px; padding:0;" onclick="playVid(1)"><i class="fas fa-play" id="icon1"></i></button>
                    <input type="range" id="sk1" value="0" disabled title="Seeking Disabled">
                    <select class="spd-sel" onchange="spd(1, this.value)">
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1.0x</option>
                        <option value="1.25">1.25x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2.0x</option>
                    </select>
                </div>
            </div>
            <div class="vt-sub-box">
                <div class="sub-list" id="subs1"></div>
            </div>
        </div>
    </div>
</div>

<div id="p6" class="page">
    <div class="container" style="max-width:1400px;">
        <div class="vt-layout">
            <div class="vt-video-col">
                <div id="hud2" class="hud">Loading Detail Question...</div>
                <video id="vid2" src="{{ config.videoFile }}" playsinline></video>
                
                <div id="ol2" class="overlay">
                    <div class="q-card">
                        <h3 id="v2-q" style="color:var(--primary);">Detail Question</h3>
                        <div id="v2-opts" style="display:flex; flex-direction:column; gap:10px;"></div>
                        
                        <div id="fb2" class="feedback-box"></div>

                        <div style="display:flex; gap:10px; justify-content:center; margin-top:20px;">
                            <button class="btn btn-outline" id="rp2" onclick="replaySeg(2)"><i class="fas fa-undo"></i> Replay</button>
                            <button id="ct2" class="btn" onclick="resume(2)" style="display:none;">Continue <i class="fas fa-play"></i></button>
                        </div>
                    </div>
                </div>
                
                <div id="rev2" class="overlay">
                    <div class="q-card" style="max-width: 700px; text-align: left;">
                        <h2 style="color:var(--primary); text-align: center;">Part 2 Review</h2>
                        <div id="rev2-list" class="review-list"></div>
                        <div style="text-align: center;"><button class="btn" onclick="toPage('p7')">See Report <i class="fas fa-flag-checkered"></i></button></div>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn btn-sm btn-icon" style="background:white; color:black; border-radius:50%; width:32px; height:32px; padding:0;" onclick="playVid(2)"><i class="fas fa-play" id="icon2"></i></button>
                    <input type="range" id="sk2" value="0" disabled title="Seeking Disabled">
                </div>
            </div>
            <div class="vt-sub-box" style="justify-content:center; align-items:center; color:#94a3b8; text-align:center;">
                <div style="font-size:3rem; margin-bottom: 10px;"><i class="fas fa-headphones"></i></div>
                <div style="font-weight: 600;">Blind Mode</div>
                <div style="font-size: 0.9rem; opacity: 0.7;">Focus on audio</div>
            </div>
        </div>
    </div>
</div>

<div id="p7" class="page">
    <div class="container" style="justify-content:center;">
        <div class="card" style="text-align:center;">
            <h1 style="color:var(--primary); font-size: 2.2rem; margin-bottom: 10px;">Mission Report</h1>
            <p style="color: var(--text-sub); margin-bottom: 30px;">Great job, <span id="r-name" style="font-weight:bold; color:var(--text-main);">Agent</span>!</p>
            <div class="report-grid">
                <div class="report-item"><span class="report-val" id="r-voc">0</span><span class="report-lbl">Vocab Pts</span></div>
                <div class="report-item"><span class="report-val" id="r-quiz">0</span><span class="report-lbl">Quiz Pts</span></div>
                <div class="report-item"><span class="report-val" id="r-vid">0</span><span class="report-lbl">Video Pts</span></div>
                <div class="report-item"><span class="report-val" id="r-time">0m</span><span class="report-lbl">Total Time</span></div>
            </div>
            <div style="margin-top: 30px;">
                <div style="font-size: 3.5rem; font-weight: 900; color: var(--accent); margin-bottom: 5px;" id="r-total">0</div>
                <div style="text-transform: uppercase; letter-spacing: 2px; font-weight: bold; color: #94a3b8;">Total Score</div>
            </div>
            <button class="btn" onclick="location.reload()" style="margin-top: 40px;">Restart Mission ‚Ü∫</button>
        </div>
    </div>
</div>

<div id="mod-voc" class="modal-mask" onclick="clsVoc()">
    <div class="modal-box" onclick="event.stopPropagation()">
        <button onclick="clsVoc()" style="position:absolute; top:20px; right:20px; border:none; background:none; font-size:1.5rem; cursor:pointer; color: #94a3b8;">&times;</button>
        <h2 style="color:var(--primary); margin-top:0; font-size: 2rem;" id="vw">Word</h2>
        <div style="margin-bottom:25px;">
            <span id="vtype" style="text-transform:uppercase; font-size:0.8rem; border:1px solid #ddd; padding:4px 10px; border-radius:6px; background: #f8fafc; font-weight: 600;">TYPE</span> 
            <i class="fas fa-volume-up" style="cursor:pointer; margin-left: 10px; color: var(--primary); font-size: 1.2rem;" onclick="speak(document.getElementById('vw').innerText)"></i>
        </div>
        <p style="font-size: 1.1rem; line-height: 1.6;"><strong>Definition:</strong> <span id="vdef"></span></p>
        <p style="font-size: 1.1rem;"><strong>Chinese:</strong> <span id="vcn" class="blur-txt" onclick="this.classList.toggle('show')"></span> <i class="fas fa-eye" style="cursor:pointer; margin-left:5px; color:#cbd5e1;"></i></p>
        
        <div style="background:#F8FAFC; padding:20px; border-radius:16px; margin-bottom:15px; border: 1px solid #E2E8F0;">
            <div style="font-size:0.75rem; font-weight:800; color:#94a3b8; text-transform: uppercase; margin-bottom: 5px;">Video Context</div>
            <div style="font-size: 1.05rem; font-weight: 500; color: var(--text-main);">"<span id="vex1"></span>" <i class="fas fa-volume-up" style="cursor:pointer; color:var(--primary); margin-left:8px;" onclick="speak(document.getElementById('vex1').innerText)"></i></div>
            <div id="vcn1" class="blur-txt" style="color:#64748b; margin-top: 5px;" onclick="this.classList.toggle('show')"></div>
        </div>
        
        <div style="background:#F0FDF4; padding:20px; border-radius:16px; border: 1px solid #BBF7D0;">
            <div style="font-size:0.75rem; font-weight:800; color:#166534; text-transform: uppercase; margin-bottom: 5px;">Daily Life</div>
            <div style="font-size: 1.05rem; font-weight: 500; color: #15803d;">"<span id="vex2"></span>" <i class="fas fa-volume-up" style="cursor:pointer; color:#15803d; margin-left:8px;" onclick="speak(document.getElementById('vex2').innerText)"></i></div>
            <div id="vcn2" class="blur-txt" style="color:#166534; margin-top: 5px;" onclick="this.classList.toggle('show')"></div>
        </div>
    </div>
</div>

<div id="ds-pop">
    <div class="ds-head"><span>AI Definition</span> <span onclick="document.getElementById('ds-pop').style.display='none'" style="cursor:pointer;">&times;</span></div>
    <div class="ds-body" id="ds-con">Taking a moment...</div>
</div>

<script>
    const D = {{ json_data | safe }};
    const C = D.config;
    let s = { u:"", lsc:0, qsc:0, vidsc:0, sv:new Set(), lrn:new Set(), pg:'p1', v1:0, v2:0, lock:false, t1:0, t2:0, logs1:[], logs2:[], startTime: Date.now() };
    const AZ_KEY = C.azureKey; const AZ_REG = C.azureRegion;
    // Updated Key to avoid cache conflicts
    const STORAGE_KEY = 'vt_course_save'; 

    window.onload = () => {
        if(localStorage.getItem(STORAGE_KEY)) document.getElementById('resume-btn').style.display='inline-block';
        initSubs();
    };

    function startApp() {
        const n=document.getElementById('username').value;
        if(n) s.u=n;
        s.startTime = Date.now();
        toPage('p2');
    }

    // üî•üî• FIXED RESUME FUNCTION START üî•üî•
    function resumeApp() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;

        try {
            const saved = JSON.parse(raw);
            
            // 1. Restore Primitive Values
            s.u = saved.u || "";
            s.lsc = saved.lsc || 0;
            s.qsc = saved.qsc || 0;
            s.vidsc = saved.vidsc || 0;
            s.pg = saved.pg || 'p1';
            s.v1 = saved.v1 || 0;
            s.v2 = saved.v2 || 0;
            s.t1 = saved.t1 || 0;
            s.t2 = saved.t2 || 0;
            s.logs1 = saved.logs1 || [];
            s.logs2 = saved.logs2 || [];
            
            // 2. Restore Sets (Critical: JSON saves Sets as Arrays, must convert back)
            s.sv = new Set(saved.sv || []);
            s.lrn = new Set(saved.lrn || []);

            // 3. Update UI to match loaded state
            if(s.u) document.getElementById('username').value = s.u;
            upUI(); // Update score display

            // 4. Visual Restoration: Re-apply 'learned' and 'saved' classes
            s.lrn.forEach(idx => {
                const el = document.getElementById('vc-' + idx);
                if(el) el.classList.add('learned');
            });
            s.sv.forEach(idx => {
                const el = document.getElementById('bm-' + idx);
                if(el) el.classList.add('saved');
            });

            // 5. Navigate to saved page
            toPage(s.pg);

        } catch (e) {
            console.error("Resume corrupted:", e);
            alert("Save file corrupted. Starting new session.");
            startApp();
        }
    }
    // üî•üî• FIXED RESUME FUNCTION END üî•üî•

    function toPage(p) {
        document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
        document.getElementById(p).classList.add('active');
        s.pg=p;
        if(p==='p5') { initVid(1); if(s.t1>0) restoreVid('vid1', s.t1); }
        if(p==='p6') { initVid(2); if(s.t2>0) restoreVid('vid2', s.t2); }
        if(p==='p7') genReport();
    }
    
    // Robust Seek Loop
    function restoreVid(id, t) {
        const v = document.getElementById(id);
        const attempt = () => {
            v.currentTime = t;
            if(Math.abs(v.currentTime - t) > 1) requestAnimationFrame(attempt);
        };
        if(v.readyState >= 1) attempt();
        else v.onloadedmetadata = attempt;
    }

    function genReport() {
        const timeSpent = Math.floor((Date.now() - s.startTime) / 60000);
        document.getElementById('r-name').innerText = s.u || "Agent";
        document.getElementById('r-voc').innerText = s.lsc;
        document.getElementById('r-quiz').innerText = s.qsc;
        document.getElementById('r-vid').innerText = s.vidsc;
        document.getElementById('r-time').innerText = timeSpent + "m";
        document.getElementById('r-total').innerText = s.lsc + s.qsc + s.vidsc;
        localStorage.removeItem(STORAGE_KEY);
    }

    function speak(txt) {
        if(window.SpeechSDK && AZ_KEY) {
            const c = SpeechSDK.SpeechConfig.fromSubscription(AZ_KEY, AZ_REG);
            c.speechSynthesisVoiceName = "en-GB-RyanNeural";
            const a = SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
            const syn = new SpeechSDK.SpeechSynthesizer(c, a);
            syn.speakTextAsync(txt, r=>{syn.close()}, e=>{syn.close(); nativeSpeak(txt)});
        } else { nativeSpeak(txt); }
    }
    function nativeSpeak(txt) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'en-GB';
        window.speechSynthesis.speak(u);
    }

    // Vocab
    let tm;
    function openVocab(i) {
        const v = D.vocab[i];
        document.getElementById('mod-voc').style.display='flex';
        document.getElementById('vw').innerText=v.w;
        document.getElementById('vtype').innerText=v.type;
        document.getElementById('vdef').innerText=v.en_def;
        document.getElementById('vcn').innerText=v.cn;
        document.getElementById('vex1').innerText=v.vid_ex;
        document.getElementById('vcn1').innerText=v.vid_cn;
        document.getElementById('vex2').innerText=v.life_ex;
        document.getElementById('vcn2').innerText=v.life_cn;
        document.querySelectorAll('.blur-txt').forEach(e=>e.classList.remove('show'));
        speak(v.w);
        clearTimeout(tm);
        tm = setTimeout(()=>{
            if(!s.lrn.has(i)) { s.lrn.add(i); s.lsc+=2; upUI(); saveState(); document.getElementById(`vc-${i}`).classList.add('learned'); }
        }, 3000); 
    }
    function clsVoc(){ document.getElementById('mod-voc').style.display='none'; clearTimeout(tm); }
    function toggleSave(e,i){ e.stopPropagation(); const el=document.getElementById(`bm-${i}`); if(s.sv.has(i)){ s.sv.delete(i); el.classList.remove('saved'); } else{ s.sv.add(i); el.classList.add('saved'); } saveState(); }

    // Quiz
    let qQ=[], qC=0;
    function getMisspelling(word) {
        if(word.length < 4) return word + "e";
        const idx = Math.floor(Math.random() * (word.length - 2)) + 1;
        return word.substring(0, idx) + word[idx+1] + word[idx] + word.substring(idx+2);
    }

    function startQuiz(pct, base) {
        s.qsc += base; upUI();
        const n = Math.ceil(D.vocab.length * pct);
        const pool = [...D.vocab].sort(()=>0.5-Math.random()).slice(0, n);
        qQ = pool.map(v => {
            const r = Math.random();
            let type = 'def'; let opts = [];
            if(r < 0.33) {
                type = 'def'; opts = [v]; while(opts.length<4) { const x=D.vocab[Math.floor(Math.random()*D.vocab.length)]; if(!opts.includes(x)) opts.push(x); } opts = opts.sort(()=>0.5-Math.random()).map(o => ({txt: o.w, isC: o.id===v.id}));
            } else if (r < 0.66) {
                type = 'lis'; const dist1 = getMisspelling(v.w); const dist2 = getMisspelling(v.w); const dist3 = getMisspelling(v.w); opts = [{txt: v.w, isC: true}, {txt: dist1, isC: false}, {txt: dist2, isC: false}, {txt: dist3, isC: false}].sort(()=>0.5-Math.random());
            } else {
                type = 'cloze'; opts = [v]; while(opts.length<4) { const x=D.vocab[Math.floor(Math.random()*D.vocab.length)]; if(!opts.includes(x)) opts.push(x); } opts = opts.sort(()=>0.5-Math.random()).map(o => ({txt: o.w, isC: o.id===v.id}));
            }
            return { c:v, t:type, o:opts };
        });
        qC=0;
        document.getElementById('qz-setup').style.display='none';
        document.getElementById('qz-run').style.display='block';
        rendQ();
    }

    function rendQ() {
        if(qC>=qQ.length) { alert("Quiz Finished!"); toPage('p5'); return; }
        const q=qQ[qC];
        document.getElementById('q-idx').innerText=qC+1;
        document.getElementById('q-fb').style.display='none';
        document.getElementById('q-nxt').style.display='none';
        const b=document.getElementById('q-content'); b.innerHTML='';
        if(q.t==='lis') { b.innerHTML=`<div style="text-align:center; margin-bottom:20px;"><button class="btn btn-outline" style="border-radius:50%; width:50px; height:50px;" onclick="speak('${q.c.w}')"><i class="fas fa-volume-up"></i></button><br><small>Listen & Choose</small></div>`; } 
        else if (q.t==='cloze') { const sent = q.c.life_ex.replace(new RegExp(q.c.w, 'gi'), '_______'); b.innerHTML=`<div style="padding:10px; font-size:1.1rem; text-align:center; margin-bottom:15px;">"${sent}"</div>`; } 
        else { b.innerHTML=`<div style="padding:10px; font-weight:bold; margin-bottom:15px;">${q.c.en_def}</div>`; }
        q.o.forEach(opt=>{
            const btn=document.createElement('div'); btn.className='btn btn-outline'; btn.style.width='100%'; btn.style.marginBottom='8px'; btn.innerText=opt.txt;
            btn.onclick=()=>chkQ(btn, opt.isC, q.c);
            b.appendChild(btn);
        });
    }

    function chkQ(btn, isC, dat) {
        document.querySelectorAll('#q-content .btn').forEach(b=>b.style.pointerEvents='none');
        if(isC) { btn.style.background='#dcfce7'; btn.style.borderColor='green'; s.qsc+=2; } 
        else { btn.style.background='#fee2e2'; btn.style.borderColor='red'; s.qsc-=1; }
        upUI(); saveState();
        const fb=document.getElementById('q-fb'); fb.style.display='block';
        fb.innerHTML=`<strong>${dat.w}</strong>: ${dat.cn}<br>${dat.life_ex}`;
        const nx=document.getElementById('q-nxt'); nx.style.display='block';
        let sec=3; nx.innerText=`Next (${sec})`;
        const ti=setInterval(()=>{ sec--; nx.innerText=`Next (${sec})`; if(sec<=0){ clearInterval(ti); qC++; rendQ(); } },1000);
        nx.onclick=()=>{ clearInterval(ti); qC++; rendQ(); };
    }
    function nextQ() { qC++; rendQ(); }

    // Video Logic (Unified)
    let curVQ=null;
    function initVid(id) {
        const v=document.getElementById(`vid${id}`);
        const qs=id===1 ? D.quizzes.general : D.quizzes.detailed;
        qs.sort((a,b)=>a.time-b.time);
        
        upHud(id, qs); // Show first Q

        v.ontimeupdate = () => {
            if(id===1) s.t1 = v.currentTime; else s.t2 = v.currentTime;
            saveState();
            const t=v.currentTime;
            const i=id===1?s.v1:s.v2;
            const sl=document.getElementById(`sk${id}`);
            sl.value=(t/v.duration)*100 || 0; 

            if(i<qs.length) {
                if(t >= qs[i].time && !s.lock) { v.pause(); s.lock=true; popVQ(id, qs[i]); }
            }
            
            if(id===1) {
                const subIdx = D.subtitles.findIndex(x=>t>=x.s && t<=x.e);
                if(subIdx !== -1) {
                    document.querySelectorAll('.sub-line').forEach(e=>e.classList.remove('active'));
                    const el = document.getElementById(`sub-${subIdx}`);
                    if(el) { el.classList.add('active'); el.scrollIntoView({behavior:'smooth', block:'center'}); }
                }
            }
            if(t >= v.duration - 0.5) showReview(id);
        };
    }

    function upHud(id, qs) {
        const i=id===1?s.v1:s.v2;
        const h=document.getElementById(`hud${id}`);
        if(i < qs.length) { h.style.display='block'; h.innerText = qs[i].q; } else { h.style.display='none'; }
    }

    function popVQ(id, q) {
        curVQ=q;
        // Reset Logic
        document.getElementById(`fb${id}`).style.display='none';
        document.getElementById(`ct${id}`).style.display='none';
        document.getElementById(`rp${id}`).style.display='inline-block';
        
        document.getElementById(`ol${id}`).style.display='flex';
        
        // Unified UI generation
        const cont = id===1 ? document.getElementById('v1-opts') : document.getElementById('v2-opts');
        cont.innerHTML = q.opts.map((o,idx)=>
            `<button class="opt-btn" onclick="ansUnified(${id}, ${idx}, ${q.ans})">${o}</button>`
        ).join('');
        
        document.getElementById(id===1 ? 'v1-q' : 'v2-q').innerText = q.q;
    }

    function ansUnified(id, idx, corr) {
        const cont = id===1 ? document.getElementById('v1-opts') : document.getElementById('v2-opts');
        const btns = cont.querySelectorAll('.opt-btn');
        btns.forEach(b => b.disabled=true);
        
        const isCorr = idx===corr;
        if(isCorr) { 
            btns[idx].classList.add('sel-correct'); 
            s.vidsc+=5;
        } else { 
            btns[idx].classList.add('sel-wrong'); 
            btns[corr].classList.add('sel-correct'); 
        }
        
        showFeedback(id, isCorr);
        if(id===1) s.logs1.push({ q: curVQ.q, uAns: curVQ.opts[idx], cAns: curVQ.opts[corr], isC: isCorr, exp: curVQ.review });
        else s.logs2.push({ q: curVQ.q, uAns: curVQ.opts[idx], cAns: curVQ.opts[corr], isC: isCorr, exp: curVQ.review });
    }

    function showFeedback(id, isCorr) {
        const fb = document.getElementById(`fb${id}`);
        fb.className = `feedback-box ${isCorr?'correct':'wrong'}`;
        fb.innerHTML = `<div class="feedback-title">${isCorr ? '<i class="fas fa-check-circle"></i> Correct!' : '<i class="fas fa-times-circle"></i> Incorrect'}</div><div class="feedback-text">${curVQ.review}</div>`;
        fb.style.display='block';
        document.getElementById(`ct${id}`).style.display='inline-block';
        document.getElementById(`rp${id}`).style.display='none';
        upUI(); saveState();
    }

    function resume(id) {
        document.getElementById(`ol${id}`).style.display='none';
        s.lock=false;
        const v=document.getElementById(`vid${id}`);
        if(id===1) s.v1++; else s.v2++;
        const qs=id===1 ? D.quizzes.general : D.quizzes.detailed;
        upHud(id, qs); 
        v.play();
        upUI(); saveState();
    }

    function replaySeg(id) {
        const v=document.getElementById(`vid${id}`);
        const start = (curVQ.replay && curVQ.replay.start) ? curVQ.replay.start : Math.max(0, v.currentTime - 15);
        v.currentTime = start;
        document.getElementById(`ol${id}`).style.display='none';
        s.lock = false;
        v.play();
    }

    function showReview(id) {
        const el = document.getElementById(`rev${id}`);
        const list = document.getElementById(`rev${id}-list`);
        const logs = id===1 ? s.logs1 : s.logs2;
        list.innerHTML = logs.map(l => `<div class="review-item ${l.isC?'correct':'wrong'}"><div class="review-q">${l.q}</div><div class="review-ans">Your Answer: <strong>${l.uAns}</strong> ${l.isC?'‚úÖ':'‚ùå'}</div>${!l.isC ? `<div class="review-ans">Correct: <strong>${l.cAns}</strong></div>` : ''}<div class="review-exp"><i class="fas fa-lightbulb"></i> ${l.exp}</div></div>`).join('');
        el.style.display = 'flex';
        document.getElementById(`vid${id}`).pause();
    }

    function playVid(id){ const v=document.getElementById(`vid${id}`); const i=document.getElementById(`icon${id}`); v.paused?v.play():v.pause(); i.className=v.paused?'fas fa-play':'fas fa-pause'; }
    function scrub(id,v){ /* Scrubbing Disabled */ }
    function spd(id,v){ document.getElementById(`vid${id}`).playbackRate=v; }
    function upUI(){ document.getElementById('u-score').innerText = s.lsc + s.qsc + s.vidsc; }
    function saveState(alertUser){ localStorage.setItem(STORAGE_KEY, JSON.stringify({...s, sv:[...s.sv], lrn:[...s.lrn]})); if(alertUser) alert("Progress Saved!"); }
    
    function initSubs() {
        const c=document.getElementById('subs1');
        D.subtitles.forEach((x,i)=>{
            const d=document.createElement('div'); d.className='sub-line'; d.id=`sub-${i}`;
            const t = x.t.split(' ').map(w=>`<span class="w-click" onclick="ds('${w.replace(/[^\w]/g,'')}')">${w}</span>`).join(' ');
            d.innerHTML=`<small style="color:#ccc; margin-right:8px;">${Math.floor(x.s/60)}:${Math.floor(x.s%60).toString().padStart(2,'0')}</small>${t}`;
            c.appendChild(d);
        });
    }
    
    async function ds(w) {
        if(!w) return;
        const p=document.getElementById('ds-pop'); p.style.display='block';
        document.getElementById('ds-con').innerHTML='Thinking...';
        try {
            const r=await fetch("https://api.deepseek.com/v1/chat/completions", {
                method:"POST", headers:{"Content-Type":"application/json", "Authorization":`Bearer ${C.deepseekKey}`},
                body: JSON.stringify({model:"deepseek-chat", messages:[{role:"user", content:`Define "${w}" for B1 student. JSON: {cn, en, ex}`}], response_format:{type:"json_object"}})
            });
            const d=JSON.parse((await r.json()).choices[0].message.content);
            document.getElementById('ds-con').innerHTML=`<div class="ds-word">${w}</div><div class="ds-cn">${d.cn}</div><div class="ds-en">${d.en}</div><div class="ds-ex"><i class="fas fa-quote-left"></i> ${d.ex}</div>`;
        } catch(e) { document.getElementById('ds-con').innerText="Error fetching definition."; }
    }

    let si=0;
    function slide(n){ const im=document.querySelectorAll('.slide-img'); im[si].style.display='none'; si=(si+n+im.length)%im.length; im[si].style.display='block'; }
</script>
</body>
</html>