<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Journey to the West: The Monkey King</title>
    <script src="https://aka.ms/csspeech/jsbrowserpackageraw"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato:wght@400;700&family=Noto+Serif+SC:wght@500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Theme: Ancient Ink & Gold */
            --primary: #780000;       /* Lacquer Red */
            --primary-light: #9B2C2C;
            --accent: #C5A059;        /* Metallic Gold */
            --ink: #2D3748;           /* Dark Ink */
            --ink-light: #4A5568;
            --paper: #FDFBF7;         /* Rice Paper */
            --parchment: #F3EFE0;     /* Aged Parchment */
            --success: #276749;       /* Jade Green */
            --danger: #9B2C2C;
            
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 12px;
            --font-head: 'Cinzel', 'Noto Serif SC', serif;
            --font-body: 'Lato', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            margin: 0; 
            font-family: var(--font-body);
            background-color: var(--parchment);
            /* Subtle texture pattern */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23dcd6c5' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            color: var(--ink); 
            height: 100vh; height: 100dvh; 
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- Header --- */
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 2px solid var(--accent);
            padding: 0 20px; height: 64px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 100; flex-shrink: 0;
        }
        .brand { font-family: var(--font-head); font-size: 1.25rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .score-pill { background: var(--parchment); border: 1px solid var(--accent); color: var(--primary); padding: 6px 16px; border-radius: 50px; font-weight: 700; font-family: var(--font-head); }

        /* --- Layout --- */
        .page { display: none; height: 100%; flex-direction: column; overflow-y: auto; padding: 20px; animation: fadeIn 0.4s ease-out; }
        .page.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .container { width: 100%; max-width: 1200px; margin: 0 auto; display: flex; flex-direction: column; gap: 25px; flex: 1; }

        /* --- Cards --- */
        .card { 
            background: var(--paper); border-radius: var(--radius); padding: 30px; 
            box-shadow: var(--shadow-card); border: 1px solid #E2E8F0; position: relative;
        }
        .card::before {
            content: ""; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent), var(--primary));
            border-radius: var(--radius) var(--radius) 0 0;
        }

        h1, h2, h3 { color: var(--primary); font-family: var(--font-head); margin-top: 0; }
        p { line-height: 1.7; color: var(--ink-light); font-size: 1.05rem; }

        /* --- Interactive Elements --- */
        .btn { 
            background: var(--primary); color: #fff; border: none; padding: 14px 28px; 
            border-radius: 8px; font-weight: 700; cursor: pointer; 
            display: inline-flex; align-items: center; justify-content: center; gap: 10px; 
            font-size: 1rem; transition: all 0.2s; box-shadow: 0 4px 6px rgba(120, 0, 0, 0.2);
            font-family: var(--font-head); letter-spacing: 0.5px;
        }
        .btn:hover { background: var(--primary-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(120, 0, 0, 0.3); }
        .btn:active { transform: scale(0.98); }
        
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); box-shadow: none; }
        .btn-outline:hover { background: #fff0f0; }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; }

        input[type="text"] {
            width: 100%; padding: 15px; border: 2px solid #cbd5e0; border-radius: 8px;
            font-size: 1.1rem; text-align: center; font-family: var(--font-head); 
            color: var(--primary); background: #fff; transition: 0.3s;
        }
        input[type="text"]:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(197, 160, 89, 0.2); }

        /* --- Rules Box --- */
        .rules-box { background: #fff; border: 2px dashed var(--accent); padding: 20px; border-radius: var(--radius); margin: 20px 0; text-align: left; }
        .rule-item { display: flex; justify-content: space-between; margin-bottom: 10px; font-weight: 600; color: var(--ink); }
        .rule-pts { color: var(--primary); background: #fff0f0; padding: 2px 8px; border-radius: 4px; font-family: var(--font-head); }

        /* --- Video Layout --- */
        .vt-layout { 
            display: flex; flex-direction: column; background: #000; border-radius: var(--radius); 
            overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 4px solid #1a1a1a;
        }
        @media (min-width: 900px) { 
            .vt-layout { flex-direction: row; height: 75vh; max-height: 800px; } 
            .vt-sub-box { width: 340px; border-left: 1px solid #333; }
        }
        .vt-video-col { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; background: #000; }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        /* HUD Fix: Ensure it wraps and doesn't get cut off */
        .hud { 
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85); color: #FFF; 
            padding: 10px 20px; border-radius: 12px; font-weight: 600; font-size: 1rem;
            z-index: 40; border: 1px solid rgba(255,255,255,0.2);
            text-align: center; 
            width: auto; max-width: 90%; 
            white-space: normal; /* FIXED: Allow wrapping */
            line-height: 1.4;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* Subtitles */
        .vt-sub-box { background: var(--paper); display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .sub-list { flex: 1; overflow-y: auto; padding: 20px; }
        .sub-line { padding: 10px; margin-bottom: 8px; border-radius: 6px; color: var(--ink-light); cursor: pointer; border-left: 3px solid transparent; transition: 0.2s; }
        .sub-line:hover { background: rgba(0,0,0,0.03); }
        .sub-line.active { background: #fff; color: var(--primary); font-weight: 700; border-left-color: var(--accent); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* Controls & Overlay */
        .controls { 
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); 
            padding: 15px 20px; display: flex; gap: 15px; align-items: center; z-index: 30;
        }
        .overlay { 
            position: absolute; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); 
            z-index: 50; display: none; flex-direction: column; justify-content: center; align-items: center; padding: 20px; 
        }
        .q-card { 
            background: var(--paper); width: 100%; max-width: 600px; padding: 30px; border-radius: var(--radius); 
            text-align: center; border: 2px solid var(--accent); box-shadow: 0 0 30px rgba(197, 160, 89, 0.2);
            max-height: 90vh; overflow-y: auto;
        }

        /* --- Vocab Grid --- */
        .vocab-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .flashcard { 
            background: #fff; border: 1px solid #e2e8f0; border-radius: var(--radius); 
            padding: 20px; text-align: center; cursor: pointer; height: 180px; 
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            position: relative; transition: 0.3s;
        }
        .flashcard:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: var(--shadow-card); }
        .flashcard.learned { background: #F0FFF4; border-color: var(--success); }
        .flashcard .tag { position: absolute; top: 10px; left: 10px; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; background: var(--parchment); color: var(--ink-light); text-transform: uppercase; }
        .flashcard .save-icon { position: absolute; top: 10px; right: 10px; color: #cbd5e1; }
        .flashcard .save-icon.saved { color: var(--accent); }
        
        /* Feedback Box (Quiz) */
        .feedback-box { margin-top: 15px; padding: 15px; border-radius: 8px; text-align: left; display: none; }
        .feedback-box.correct { background: #F0FFF4; color: var(--success); border: 1px solid #C6F6D5; }
        .feedback-box.wrong { background: #FFF5F5; color: var(--danger); border: 1px solid #FED7D7; }
        
        .opt-btn {
            display: block; width: 100%; text-align: left; padding: 16px; 
            margin-bottom: 12px; border: 2px solid #e2e8f0; border-radius: 8px;
            background: #fff; font-size: 1rem; cursor: pointer; transition: 0.2s; color: var(--ink);
        }
        .opt-btn:hover:not(:disabled) { border-color: var(--primary); background: #fff5f5; }
        .opt-btn.sel-correct { background: #F0FFF4; border-color: var(--success); color: var(--success); font-weight: bold; }
        .opt-btn.sel-wrong { background: #FFF5F5; border-color: var(--danger); color: var(--danger); }

        /* --- Modals --- */
        .modal-mask { position: fixed; inset: 0; background: rgba(45, 55, 72, 0.8); backdrop-filter: blur(4px); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal-box { background: var(--paper); width: 100%; max-width: 550px; border-radius: var(--radius); padding: 30px; border: 2px solid var(--accent); max-height: 90vh; overflow-y: auto; }
        .blur-txt { filter: blur(6px); opacity: 0.6; transition: 0.2s; cursor: pointer; user-select: none; }
        .blur-txt.show { filter: none; opacity: 1; }

        /* DeepSeek Popup */
        #ds-pop { 
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: #fff; 
            border-radius: var(--radius); box-shadow: 0 10px 40px rgba(0,0,0,0.3); 
            z-index: 3000; display: none; overflow: hidden; border: 1px solid var(--accent);
        }
        .ds-head { background: var(--primary); color: #fff; padding: 12px 20px; font-weight: bold; display: flex; justify-content: space-between; }
        .ds-body { padding: 20px; }
    </style>
</head>
<body>

<div class="header">
    <div class="brand"><i class="fas fa-scroll"></i> Journey to the West</div>
    <div style="display:flex; gap:10px; align-items: center;">
        <div class="score-pill"><i class="fas fa-dragon"></i> <span id="u-score">0</span></div>
        <button class="btn btn-sm btn-outline" onclick="saveState(true)"><i class="fas fa-save"></i> Save</button>
    </div>
</div>

<div id="p1" class="page active">
    <div class="container" style="justify-content:center; align-items:center;">
        <div class="card" style="width: 100%; max-width: 500px; text-align: center;">
            <div style="font-size:4rem; color:var(--primary); margin-bottom:15px;"><i class="fas fa-cloud-sun"></i></div>
            <h1 style="font-size: 2.2rem; margin-bottom: 10px;">The Monkey King</h1>
            <p style="font-style: italic; color:var(--ink-light);">A journey of redemption and discipline.</p>
            
            <div class="rules-box">
                <div class="rule-item"><span><i class="fas fa-book"></i> Learn Vocab</span><span class="rule-pts">+2 pts</span></div>
                <div class="rule-item"><span><i class="fas fa-puzzle-piece"></i> Quiz Mode</span><span class="rule-pts">+/- 1 pt</span></div>
                <div class="rule-item"><span><i class="fas fa-film"></i> Video Quest</span><span class="rule-pts">+5 pts</span></div>
            </div>

            <input type="text" id="username" placeholder="Enter Your Name, Traveler">
            <button class="btn" style="width:100%; margin-top: 20px; font-size:1.1rem; padding:16px;" onclick="startApp()">Begin Journey <i class="fas fa-arrow-right"></i></button>
            <div style="margin-top:15px;"><button id="resume-btn" class="btn btn-sm btn-outline" style="display:none; width: 100%;" onclick="resumeApp()">Resume Last Session</button></div>
        </div>
    </div>
</div>

<div id="p2" class="page">
    <div class="container">
        <div class="card" style="height:100%;">
            <h2 style="border-bottom: 1px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">The Legend Unfolds</h2>
            
            <div style="flex-shrink:0; position:relative; height:300px; background:#000; border-radius:8px; overflow:hidden; margin-bottom:25px; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);">
                
                <div class="slide-img" style="display:block; width:100%; height:100%;">
                    <img src="wukong_trapped.jpg" alt="Sun Wukong trapped under the mountain" style="width:100%; height:100%; object-fit:cover; opacity: 0.9;">
                    <div style="position:absolute; bottom:0; width:100%; background:linear-gradient(transparent, rgba(0,0,0,0.9)); color:white; padding:20px; font-family:var(--font-head);">The Monkey King imprisoned beneath the Five Finger Mountain.</div>
                </div>
                
                <div class="slide-img" style="display:none; width:100%; height:100%;">
                    <img src="guanyin_offer.jpg" alt="Guanyin offering items" style="width:100%; height:100%; object-fit:cover; opacity: 0.9;">
                    <div style="position:absolute; bottom:0; width:100%; background:linear-gradient(transparent, rgba(0,0,0,0.9)); color:white; padding:20px; font-family:var(--font-head);">Bodhisattva Guanyin offers a path to redemption.</div>
                </div>
                
                <div class="slide-img" style="display:none; width:100%; height:100%;">
                    <img src="golden_band.jpg" alt="The Golden Band" style="width:100%; height:100%; object-fit:cover; opacity: 0.9;">
                    <div style="position:absolute; bottom:0; width:100%; background:linear-gradient(transparent, rgba(0,0,0,0.9)); color:white; padding:20px; font-family:var(--font-head);">The Golden Fillet tightens, teaching discipline through pain.</div>
                </div>
                
                <div class="slide-img" style="display:none; width:100%; height:100%;">
                    <img src="journey_west.jpg" alt="Journey to the West" style="width:100%; height:100%; object-fit:cover; opacity: 0.9;">
                    <div style="position:absolute; bottom:0; width:100%; background:linear-gradient(transparent, rgba(0,0,0,0.9)); color:white; padding:20px; font-family:var(--font-head);">Tripitaka and Wukong set forth towards the West.</div>
                </div>
                
                <button onclick="slide(-1)" style="position:absolute; top:50%; left:15px; transform:translateY(-50%); background:rgba(0,0,0,0.6); color:white; width:40px; height:40px; border-radius:50%; border:1px solid rgba(255,255,255,0.3); cursor:pointer; font-size: 1.2rem;">❮</button>
                <button onclick="slide(1)" style="position:absolute; top:50%; right:15px; transform:translateY(-50%); background:rgba(0,0,0,0.6); color:white; width:40px; height:40px; border-radius:50%; border:1px solid rgba(255,255,255,0.3); cursor:pointer; font-size: 1.2rem;">❯</button>
            </div>

            <div style="flex:1; overflow-y:auto; padding-right:10px; font-size: 1.1rem; color: var(--ink);">
                <p>After causing chaos in the heavens and being imprisoned, the Monkey King is offered a chance at redemption by serving as a disciple to the monk Tripitaka on a journey to retrieve scriptures. <i class="fas fa-volume-up" style="color:var(--primary); cursor:pointer; margin-left:8px;" onclick="speak(`After causing chaos in the heavens and being imprisoned, the Monkey King is offered a chance at redemption by serving as a disciple to the monk Tripitaka on a journey to retrieve scriptures.`)"></i></p>
                <p>Despite initial agreement, Sun Wukong's old habits resurface, leading to conflict with Tripitaka and a magical golden band that controls his actions. <i class="fas fa-volume-up" style="color:var(--primary); cursor:pointer; margin-left:8px;" onclick="speak(`Despite initial agreement, Sun Wukong's old habits resurface, leading to conflict with Tripitaka and a magical golden band that controls his actions.`)"></i></p>
                <p>Through trials and tribulations, Sun Wukong confronts his ego and gradually learns the importance of discipline and cooperation as he journeys westward. <i class="fas fa-volume-up" style="color:var(--primary); cursor:pointer; margin-left:8px;" onclick="speak(`Through trials and tribulations, Sun Wukong confronts his ego and gradually learns the importance of discipline and cooperation as he journeys westward.`)"></i></p>
            </div>
            
            <div style="text-align:right; margin-top:20px;">
                <button class="btn" onclick="toPage('p3')">Study Vocabulary <i class="fas fa-book-open"></i></button>
            </div>
        </div>
    </div>
</div>

<div id="p3" class="page">
    <div class="container">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 25px;">
                <h2 style="margin:0;">Scrolls of Wisdom</h2>
                <div style="color:var(--ink-light); font-size: 0.9rem;">Tap cards to learn</div>
            </div>
            
            <div class="vocab-grid" id="vocab-container">
                </div>
            
            <div style="text-align:center; margin-top:40px;">
                <button class="btn" onclick="toPage('p4')">Take Challenge <i class="fas fa-scroll"></i></button>
            </div>
        </div>
    </div>
</div>

<div id="p4" class="page">
    <div class="container" style="justify-content:center;">
        <div class="card" style="text-align:center; max-width:600px; margin:0 auto;">
            <div id="qz-setup">
                <h2>Choose Your Difficulty</h2>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:25px;">
                    <button class="btn btn-outline" style="padding:20px; border-radius: 12px;" onclick="startQuiz(0.3, 30)">
                        <div style="font-size:1.1rem; font-weight:bold;">Novice</div>
                        <div style="font-size:0.85rem; opacity: 0.8;">Base: 30 pts</div>
                    </button>
                    <button class="btn btn-outline" style="padding:20px; border-radius: 12px;" onclick="startQuiz(0.5, 60)">
                        <div style="font-size:1.1rem; font-weight:bold;">Disciple</div>
                        <div style="font-size:0.85rem; opacity: 0.8;">Base: 60 pts</div>
                    </button>
                    <button class="btn btn-outline" style="padding:20px; border-radius: 12px;" onclick="startQuiz(0.8, 100)">
                        <div style="font-size:1.1rem; font-weight:bold;">Master</div>
                        <div style="font-size:0.85rem; opacity: 0.8;">Base: 100 pts</div>
                    </button>
                    <button class="btn btn-outline" style="padding:20px; border-radius: 12px;" onclick="startQuiz(1.0, 140)">
                        <div style="font-size:1.1rem; font-weight:bold;">Immortal</div>
                        <div style="font-size:0.85rem; opacity: 0.8;">Base: 140 pts</div>
                    </button>
                </div>
            </div>
            <div id="qz-run" style="display:none; text-align:left;">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px; font-family:var(--font-head);">
                    <strong>Question: <span id="q-idx">1</span></strong>
                    <span style="color:var(--primary); font-weight:bold;">Score: <span id="q-score">0</span></span>
                </div>
                <div id="q-content"></div>
                <div id="q-fb" class="feedback-box"></div>
                <button id="q-nxt" class="btn" style="width:100%; margin-top:20px; display:none;" onclick="nextQ()">Next Question</button>
            </div>
        </div>
    </div>
</div>

<div id="p5" class="page">
    <div class="container" style="max-width:1400px;">
        <div class="vt-layout">
            <div class="vt-video-col">
                <div id="hud1" class="hud">Loading Question...</div>
                <video id="vid1" src="Video.mp4" playsinline></video>
                
                <div id="ol1" class="overlay">
                    <div class="q-card">
                        <h3 id="v1-q" style="margin-bottom: 25px;">Question</h3>
                        <div id="v1-opts" style="display:flex; flex-direction:column; gap:10px;"></div>
                        <div id="fb1" class="feedback-box"></div>
                        <div style="margin-top:25px; display:flex; gap:15px; justify-content:center;">
                            <button class="btn btn-outline" id="rp1" onclick="replaySeg(1)"><i class="fas fa-undo"></i> Replay Segment</button>
                            <button class="btn" id="ct1" onclick="resume(1)" style="display:none;">Continue <i class="fas fa-play"></i></button>
                        </div>
                    </div>
                </div>
                
                <div id="rev1" class="overlay">
                    <div class="q-card" style="text-align: left;">
                        <h2 style="text-align: center; margin-bottom: 20px;">Part 1 Complete</h2>
                        <div id="rev1-list" style="max-height: 50vh; overflow-y: auto; margin-bottom: 20px;"></div>
                        <div style="text-align: center;"><button class="btn" onclick="toPage('p6')">Proceed to Part 2 <i class="fas fa-arrow-right"></i></button></div>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn btn-sm" style="background:white; color:var(--primary); border-radius:50%; width:40px; height:40px; padding:0; display:flex; align-items:center; justify-content:center;" onclick="playVid(1)"><i class="fas fa-play" id="icon1"></i></button>
                    <input type="range" id="sk1" value="0" disabled style="flex:1; height:4px; opacity:0.5; cursor: default;">
                    <select class="btn btn-sm btn-outline" style="background:rgba(0,0,0,0.5); color:white; border-color:rgba(255,255,255,0.3);" onchange="spd(1, this.value)">
                        <option value="0.75">0.75x</option>
                        <option value="1" selected>1.0x</option>
                        <option value="1.25">1.25x</option>
                    </select>
                </div>
            </div>
            <div class="vt-sub-box">
                <div class="sub-list" id="subs1"></div>
            </div>
        </div>
    </div>
</div>

<div id="p6" class="page">
    <div class="container" style="max-width:1400px;">
        <div class="vt-layout">
            <div class="vt-video-col">
                <div id="hud2" class="hud">Loading Detail Question...</div>
                <video id="vid2" src="Video.mp4" playsinline></video>
                
                <div id="ol2" class="overlay">
                    <div class="q-card">
                        <h3 id="v2-q" style="margin-bottom: 25px;">Detail Question</h3>
                        <div id="v2-opts" style="display:flex; flex-direction:column; gap:10px;"></div>
                        <div id="fb2" class="feedback-box"></div>
                        <div style="margin-top:25px; display:flex; gap:15px; justify-content:center;">
                            <button class="btn btn-outline" id="rp2" onclick="replaySeg(2)"><i class="fas fa-undo"></i> Replay</button>
                            <button id="ct2" class="btn" onclick="resume(2)" style="display:none;">Continue <i class="fas fa-play"></i></button>
                        </div>
                    </div>
                </div>
                
                <div id="rev2" class="overlay">
                    <div class="q-card" style="text-align: left;">
                        <h2 style="text-align: center; margin-bottom: 20px;">Part 2 Complete</h2>
                        <div id="rev2-list" style="max-height: 50vh; overflow-y: auto; margin-bottom: 20px;"></div>
                        <div style="text-align: center;"><button class="btn" onclick="toPage('p7')">View Final Report <i class="fas fa-flag-checkered"></i></button></div>
                    </div>
                </div>

                <div class="controls">
                    <button class="btn btn-sm" style="background:white; color:var(--primary); border-radius:50%; width:40px; height:40px; padding:0; display:flex; align-items:center; justify-content:center;" onclick="playVid(2)"><i class="fas fa-play" id="icon2"></i></button>
                    <input type="range" id="sk2" value="0" disabled style="flex:1; height:4px; opacity:0.5; cursor: default;">
                </div>
            </div>
            
            <div class="vt-sub-box" style="justify-content:center; align-items:center; color:var(--ink-light); text-align:center; background:#f0f0f0;">
                <div style="font-size:3rem; margin-bottom: 15px; color:#cbd5e0;"><i class="fas fa-headphones-alt"></i></div>
                <div style="font-weight: 700; font-family: var(--font-head);">Audio Focus</div>
                <div style="font-size: 0.9rem; opacity: 0.7;">Visuals are hidden for this part.</div>
            </div>
        </div>
    </div>
</div>

<div id="p7" class="page">
    <div class="container" style="justify-content:center;">
        <div class="card" style="text-align:center; max-width: 600px; margin: 0 auto;">
            <div style="font-size: 4rem; color: var(--accent); margin-bottom: 10px;"><i class="fas fa-award"></i></div>
            <h1 style="font-size: 2.5rem; margin-bottom: 10px;">Mission Report</h1>
            <p style="margin-bottom: 30px;">Well done, <span id="r-name" style="font-weight:bold; color:var(--primary);">Traveler</span>.</p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                <div style="background:#fff; padding:20px; border-radius:8px; border:1px solid #e2e8f0;">
                    <span style="display:block; font-size:2rem; font-weight:800; color:var(--primary);" id="r-voc">0</span>
                    <span style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; color:var(--ink-light);">Vocab Pts</span>
                </div>
                <div style="background:#fff; padding:20px; border-radius:8px; border:1px solid #e2e8f0;">
                    <span style="display:block; font-size:2rem; font-weight:800; color:var(--primary);" id="r-quiz">0</span>
                    <span style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; color:var(--ink-light);">Quiz Pts</span>
                </div>
                <div style="background:#fff; padding:20px; border-radius:8px; border:1px solid #e2e8f0;">
                    <span style="display:block; font-size:2rem; font-weight:800; color:var(--primary);" id="r-vid">0</span>
                    <span style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; color:var(--ink-light);">Video Pts</span>
                </div>
                <div style="background:#fff; padding:20px; border-radius:8px; border:1px solid #e2e8f0;">
                    <span style="display:block; font-size:2rem; font-weight:800; color:var(--primary);" id="r-time">0m</span>
                    <span style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; color:var(--ink-light);">Time</span>
                </div>
            </div>
            
            <div style="background: var(--primary); color: white; padding: 20px; border-radius: 8px;">
                <div style="font-size: 3rem; font-weight: 900; line-height: 1;" id="r-total">0</div>
                <div style="text-transform: uppercase; letter-spacing: 2px; font-weight: bold; opacity: 0.9;">Total Score</div>
            </div>
            
            <button class="btn btn-outline" onclick="location.reload()" style="margin-top: 30px; width: 100%;">Restart Journey ↺</button>
        </div>
    </div>
</div>

<div id="mod-voc" class="modal-mask" onclick="clsVoc()">
    <div class="modal-box" onclick="event.stopPropagation()">
        <button onclick="clsVoc()" style="position:absolute; top:20px; right:20px; border:none; background:none; font-size:1.5rem; cursor:pointer; color: var(--ink-light);">&times;</button>
        
        <div style="display:flex; align-items:baseline; gap:15px; margin-bottom: 10px;">
            <h2 id="vw" style="font-size: 2.2rem; margin:0;">Word</h2>
            <i class="fas fa-volume-up" style="cursor:pointer; color:var(--primary); font-size: 1.2rem;" onclick="speak(document.getElementById('vw').innerText)"></i>
        </div>
        
        <span id="vtype" style="text-transform:uppercase; font-size:0.75rem; border:1px solid var(--accent); color:var(--primary); padding:2px 8px; border-radius:4px; font-weight: 700; background:#fff;">TYPE</span> 
        
        <p style="font-size: 1.15rem; line-height: 1.6; margin: 20px 0;"><strong>Definition:</strong> <span id="vdef"></span></p>
        <p style="font-size: 1.1rem; border-bottom: 1px solid #eee; padding-bottom: 15px;"><strong>Chinese:</strong> <span id="vcn" class="blur-txt" onclick="this.classList.toggle('show')"></span> <i class="fas fa-eye" style="cursor:pointer; color:#cbd5e1; margin-left:5px;"></i></p>
        
        <div style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:15px; border-left: 4px solid var(--primary);">
            <div style="font-size:0.7rem; font-weight:800; color:var(--ink-light); text-transform: uppercase; margin-bottom: 5px;">Video Context</div>
            <div style="font-style: italic; color: var(--ink);">"<span id="vex1"></span>" <i class="fas fa-volume-up" style="cursor:pointer; color:var(--primary); margin-left:5px;" onclick="speak(document.getElementById('vex1').innerText)"></i></div>
            <div id="vcn1" class="blur-txt" style="color:var(--ink-light); margin-top:5px;" onclick="this.classList.toggle('show')"></div>
        </div>
        
        <div style="background:#F0FFF4; padding:15px; border-radius:8px; border-left: 4px solid var(--success);">
            <div style="font-size:0.7rem; font-weight:800; color:var(--success); text-transform: uppercase; margin-bottom: 5px;">Daily Life</div>
            <div style="color: #276749;">"<span id="vex2"></span>" <i class="fas fa-volume-up" style="cursor:pointer; color:var(--success); margin-left:5px;" onclick="speak(document.getElementById('vex2').innerText)"></i></div>
            <div id="vcn2" class="blur-txt" style="color:#276749; margin-top:5px;" onclick="this.classList.toggle('show')"></div>
        </div>
    </div>
</div>

<div id="ds-pop">
    <div class="ds-head"><span>AI Definition</span> <span onclick="document.getElementById('ds-pop').style.display='none'" style="cursor:pointer;">&times;</span></div>
    <div class="ds-body" id="ds-con">Consulting the scrolls...</div>
</div>

<script>
  // Configuration & Data
    const D = {
        "config": {
            "title": "The Monkey King's Journey to Redemption",
            "theme": {
                "primary": "#A85533",
                "accent": "#FACC15",
                "bg_start": "#FFF7ED",
                "bg_end": "#FFEEDD"
            },
            "quizTiers": [
                { "percent": 0.3, "base": 30, "label": "Basic" },
                { "percent": 0.5, "base": 60, "label": "Standard" },
                { "percent": 0.8, "base": 100, "label": "Advanced" },
                { "percent": 1.0, "base": 140, "label": "Master" }
            ],
            "videoFile": "Video.mp4",
            "azureKey": "DKRXk8ueSfo5NdIOMqFRTCAfpeGDezJ3Snf5K8gGgtyqxiWdugLzJQQJ99BLACHYHv6XJ3w3AAAYACOGUYP9",
            "azureRegion": "eastus2",
            "deepseekKey": "sk-daa16008e81843deba6fefe9dce51465"
        },
        "reading": [
            { "text": "After causing chaos in the heavens and being imprisoned, the Monkey King is offered a chance at redemption by serving as a disciple to the monk Tripitaka on a journey to retrieve scriptures." },
            { "text": "Despite initial agreement, Sun Wukong's old habits resurface, leading to conflict with Tripitaka and a magical golden band that controls his actions." },
            { "text": "Through trials and tribulations, Sun Wukong confronts his ego and gradually learns the importance of discipline and cooperation as he journeys westward." }
        ],
        // Updated Images with Local Paths and Context Descriptions
        "images": [
            {
                "prompt": "Sun Wukong trapped under the Five Finger Mountain.",
                "src": "wukong_trapped.jpg"
            },
            {
                "prompt": "Bodhisattva Guanyin offering the golden band and silk robe.",
                "src": "guanyin_offer.jpg"
            },
            {
                "prompt": "Sun Wukong wearing the golden circlet, in pain.",
                "src": "golden_band.jpg"
            },
            {
                "prompt": "Silhouette of Monk Tripitaka and Monkey King walking into the sunset.",
                "src": "journey_west.jpg"
            }
        ],
        // Complete Vocab List (Retained with Chinese & Examples)
        "vocab": [
            { "id": 0, "w": "havoc", "type": "general", "en_def": "widespread destruction", "cn": "混乱", "vid_ex": "After wrecking havoc across the heavens, pilfering a potion of immortality, and defeating the strongest warriors in the Jade Emperor's court, the Monkey King had finally been captured in a white hot prison cell.", "vid_cn": "在天上造成严重破坏，偷走了永生的药剂，并击败了玉皇大帝宫廷中最强大的战士之后，猴王最终被囚禁在一个炽热的牢房里。", "life_ex": "The storm wreaked havoc on the coastal villages.", "life_cn": "这场风暴对沿海村庄造成了严重破坏。" },
            { "id": 1, "w": "pilfering", "type": "general", "en_def": "stealing in small quantities", "cn": "盗取", "vid_ex": "After wrecking havoc across the heavens, pilfering a potion of immortality, and defeating the strongest warriors in the Jade Emperor's court, the Monkey King had finally been captured in a white hot prison cell.", "vid_cn": "在天上造成严重破坏，偷走了永生的药剂，并击败了玉皇大帝宫廷中最强大的战士之后，猴王最终被囚禁在一个炽热的牢房里。", "life_ex": "He was caught pilfering office supplies from his workplace.", "life_cn": "他被抓到从工作场所偷窃办公用品。" },
            { "id": 2, "w": "immortality", "type": "general", "en_def": "the ability to live forever", "cn": "永生", "vid_ex": "After wrecking havoc across the heavens, pilfering a potion of immortality, and defeating the strongest warriors in the Jade Emperor's court, the Monkey King had finally been captured in a white hot prison cell.", "vid_cn": "在天上造成严重破坏，偷走了永生的药剂，并击败了玉皇大帝宫廷中最强大的战士之后，猴王最终被囚禁在一个炽热的牢房里。", "life_ex": "Many ancient myths explore the concept of immortality.", "life_cn": "许多古代神话探索了永生的概念。" },
            { "id": 3, "w": "inflamed", "type": "general", "en_def": "to provoke or intensify", "cn": "激怒", "vid_ex": "But rather than cooking him to a crisp, the sweltering cage had inflamed its captive strength.", "vid_cn": "但是，酷热的牢笼非但没有把他烤成脆片，反而激发了他的囚禁力量。", "life_ex": "The controversial statement inflamed public opinion.", "life_cn": "有争议的声明激起了公众舆论。" },
            { "id": 4, "w": "captive", "type": "general", "en_def": "a person who has been taken prisoner or is being kept in confinement", "cn": "俘虏", "vid_ex": "But rather than cooking him to a crisp, the sweltering cage had inflamed its captive strength.", "vid_cn": "但是，酷热的牢笼非但没有把他烤成脆片，反而激发了他的囚禁力量。", "life_ex": "The zookeepers ensured the captive animals had adequate food and shelter.", "life_cn": "动物园管理员确保被圈养的动物有足够的食物和住所。" },
            { "id": 5, "w": "itching", "type": "general", "en_def": "to have a strong desire to do something", "cn": "渴望", "vid_ex": "Now he was free once more and itching for a fight.", "vid_cn": "现在他再次自由，渴望战斗。", "life_ex": "She was itching to travel abroad after finishing her studies.", "life_cn": "完成学业后，她渴望出国旅行。" },
            { "id": 6, "w": "supreme", "type": "general", "en_def": "highest in rank or authority", "cn": "至高无上的", "vid_ex": "Desperate, the Jade Emperor called on the only being stronger than he, the supreme power in all the heavens, the Buddha himself.", "vid_cn": "绝望之下，玉皇大帝求助于唯一比他更强大的存在，即天上至高无上的力量，佛陀本人。", "life_ex": "The supreme court is the highest judicial body in the country.", "life_cn": "最高法院是该国最高的司法机构。" },
            { "id": 7, "w": "almighty", "type": "general", "en_def": "having complete power", "cn": "全能的", "vid_ex": "Even in the face of this almighty opponent, Sun Wukong was not one to grovel.", "vid_cn": "即使面对这位全能的对手，孙悟空也没有卑躬屈膝。", "life_ex": "Many religions believe in an almighty God.", "life_cn": "许多宗教信仰全能的上帝。" },
            { "id": 8, "w": "grovel", "type": "general", "en_def": "to act in an obsequious manner in order to obtain someone's forgiveness or favor", "cn": "卑躬屈膝", "vid_ex": "Even in the face of this almighty opponent, Sun Wukong was not one to grovel.", "vid_cn": "即使面对这位全能的对手，孙悟空也没有卑躬屈膝。", "life_ex": "He refused to grovel before his superiors, even if it meant losing his job.", "life_cn": "他拒绝在上级面前卑躬屈膝，即使这意味着失去工作。" },
            { "id": 9, "w": "boasting", "type": "general", "en_def": "talking with excessive pride and self-satisfaction about one's achievements, possessions, or abilities", "cn": "吹嘘", "vid_ex": "He began boasting of his many talents and demanded the Emperor's crown.", "vid_cn": "他开始吹嘘自己的许多才能，并要求获得皇帝的皇冠。", "life_ex": "He was boasting about his new car to all his friends.", "life_cn": "他向所有的朋友吹嘘他的新车。" },
            { "id": 10, "w": "grant", "type": "general", "en_def": "agree to give or allow (something requested) to someone", "cn": "授予", "vid_ex": "Smiling, the Buddha declared he would grant that wish if Sun Wukong could somersault out of his palm.", "vid_cn": "佛陀笑着宣布，如果孙悟空能从他的手掌中翻身出去，他就会满足这个愿望。", "life_ex": "The government decided to grant them asylum.", "life_cn": "政府决定给予他们庇护。" },
            { "id": 11, "w": "somersault", "type": "general", "en_def": "perform an acrobatic movement in which the body turns head over heels in the air or on the ground", "cn": "翻筋斗", "vid_ex": "Smiling, the Buddha declared he would grant that wish if Sun Wukong could somersault out of his palm.", "vid_cn": "佛陀笑着宣布，如果孙悟空能从他的手掌中翻身出去，他就会满足这个愿望。", "life_ex": "The gymnast performed a perfect somersault.", "life_cn": "体操运动员完成了一个完美的翻筋斗。" },
            { "id": 12, "w": "pranced", "type": "general", "en_def": "move with high springy steps", "cn": "雀跃", "vid_ex": "The Monkey King gladly pranced onto the Buddha's hand and shot into the air, landing in a far off region where 5 pink pillars seemed to mark the edge of the.", "vid_cn": "猴王高兴地跳到佛陀的手上，射向空中，降落在遥远的地方，那里有5根粉红色的柱子似乎标志着边缘。", "life_ex": "The children pranced around the maypole.", "life_cn": "孩子们绕着五月柱雀跃。" },
            { "id": 13, "w": "cackling", "type": "general", "en_def": "laughing in a loud, harsh way", "cn": "咯咯笑", "vid_ex": "Cackling with Glee, Sun Wukong proudly marked his territory.", "vid_cn": "孙悟空高兴地咯咯笑着，自豪地标记了他的领地。", "life_ex": "The witch was cackling as she stirred her cauldron.", "life_cn": "女巫搅拌着她的如锅时咯咯地笑着。" },
            { "id": 14, "w": "odour", "type": "general", "en_def": "a distinctive smell, especially an unpleasant one", "cn": "气味", "vid_ex": "Returning to the Buddha, he demanded his new title, but he was distracted by a familiar odour.", "vid_cn": "回到佛陀身边，他要求获得他的新头衔，但他被一股熟悉的气味分散了注意力。", "life_ex": "The odour of freshly baked bread filled the air.", "life_cn": "新鲜出炉的面包的香味弥漫在空气中。" },
            { "id": 15, "w": "transformed", "type": "general", "en_def": "make a marked change in the form, nature, or appearance of", "cn": "转变", "vid_ex": "Suddenly, those five fingers transformed into a mountain range, which flipped and pinned Sun Wukong to the ground.", "vid_cn": "突然，那五根手指变成了山脉，翻转过来，把孙悟空压在地上。", "life_ex": "The caterpillar transformed into a butterfly.", "life_cn": "毛毛虫变成了蝴蝶。" },
            { "id": 16, "w": "secured", "type": "general", "en_def": "fastened or protected against attack or escape", "cn": "固定", "vid_ex": "Using a sacred seal, the Buddha secured the prison, trapping the Monkey King for good unless he could learn to change.", "vid_cn": "佛陀用神圣的封印固定了监狱，永远地困住了猴王，除非他能学会改变。", "life_ex": "The climbers secured the rope to the rock face.", "life_cn": "登山者将绳索固定在岩壁上。" },
            { "id": 17, "w": "mystical", "type": "general", "en_def": "inspiring a sense of mystery and wonder", "cn": "神秘的", "vid_ex": "Seeing the mystical tag, Sun Wukong knew he couldn't escape unaided, but it took centuries before he truly admitted defeat.", "vid_cn": "看到神秘的标签，孙悟空知道他无法独自逃脱，但他花了几个世纪才真正承认失败。", "life_ex": "The ancient temple had a mystical atmosphere.", "life_cn": "古老的寺庙有一种神秘的气氛。" },
            { "id": 18, "w": "unaided", "type": "general", "en_def": "without help; alone", "cn": "独自", "vid_ex": "Seeing the mystical tag, Sun Wukong knew he couldn't escape unaided, but it took centuries before he truly admitted defeat.", "vid_cn": "看到神秘的标签，孙悟空知道他无法独自逃脱，但他花了几个世纪才真正承认失败。", "life_ex": "She completed the marathon unaided.", "life_cn": "她独自完成了马拉松比赛。" },
            { "id": 19, "w": "imprisonment", "type": "general", "en_def": "the state of being imprisoned", "cn": "监禁", "vid_ex": "After 500 years of imprisonment, he'd grown increasingly desperate, finally vowing to mend his ways.", "vid_cn": "经过500年的监禁，他变得越来越绝望，最终发誓要改过自新。", "life_ex": "His imprisonment had a profound effect on his life.", "life_cn": "他的监禁对他的生活产生了深远的影响。" },
            { "id": 20, "w": "vowing", "type": "general", "en_def": "making a solemn promise", "cn": "发誓", "vid_ex": "After 500 years of imprisonment, he'd grown increasingly desperate, finally vowing to mend his ways.", "vid_cn": "经过500年的监禁，他变得越来越绝望，最终发誓要改过自新。", "life_ex": "She was vowing to lose weight.", "life_cn": "她发誓要减肥。" },
            { "id": 21, "w": "bodhisattva", "type": "general", "en_def": "a person who is able to reach nirvana but delays doing so out of compassion in order to save suffering beings.", "cn": "菩萨", "vid_ex": "So when the bodhisattva Guanyin happened by his prison on a sacred journey, he promised to pursue enlightenment if she would end his torment.", "vid_cn": "因此，当菩萨观音在她神圣的旅程中路过他的监狱时，他答应如果她结束他的折磨，他将追求启迪。", "life_ex": "The bodhisattva embodies compassion and wisdom.", "life_cn": "菩萨体现了慈悲和智慧。" },
            { "id": 22, "w": "enlightenment", "type": "general", "en_def": "the state of gaining spiritual knowledge or insight; freedom from ignorance, prejudice, or superstition", "cn": "启迪", "vid_ex": "So when the bodhisattva Guanyin happened by his prison on a sacred journey, he promised to pursue enlightenment if she would end his torment.", "vid_cn": "因此，当菩萨观音在她神圣的旅程中路过他的监狱时，他答应如果她结束他的折磨，他将追求启迪。", "life_ex": "Many people seek enlightenment through meditation.", "life_cn": "许多人通过冥想寻求启迪。" },
            { "id": 23, "w": "torment", "type": "general", "en_def": "severe physical or mental suffering", "cn": "折磨", "vid_ex": "So when the bodhisattva Guanyin happened by his prison on a sacred journey, he promised to pursue enlightenment if she would end his torment.", "vid_cn": "因此，当菩萨观音在她神圣的旅程中路过他的监狱时，他答应如果她结束他的折磨，他将追求启迪。", "life_ex": "The toothache caused him constant torment.", "life_cn": "牙痛给他带来了持续的折磨。" },
            { "id": 24, "w": "skeptical", "type": "general", "en_def": "not easily convinced; having doubts or reservations", "cn": "怀疑的", "vid_ex": "The goddess of Compassion was skeptical of Sun Wukong's change of heart, but decided to give him an opportunity to prove himself.", "vid_cn": "慈悲女神对孙悟空的改变持怀疑态度，但决定给他一个证明自己的机会。", "life_ex": "I'm skeptical about his claims.", "life_cn": "我对他的说法表示怀疑。" },
            { "id": 25, "w": "overseeing", "type": "general", "en_def": "supervising", "cn": "监督", "vid_ex": "At that time, the goddess was overseeing another sacred quest.", "vid_cn": "那时，女神正在监督另一项神圣的探险。", "life_ex": "She is overseeing the construction project.", "life_cn": "她正在监督这个建设项目。" },
            { "id": 26, "w": "righteous", "type": "general", "en_def": "morally right or justifiable", "cn": "正义的", "vid_ex": "Pursued by a righteous monk named Tripitaka, he'd set out to retrieve scriptures from the West, but the path was too long and dangerous to travel alone, so Guanyin promised to arrange Sun Wukong's freedom if he had served as a monk's faithful disciple.", "vid_cn": "在一位名叫唐三藏的正义僧侣的追捕下，他出发去西方取经，但这条路太长太危险，不能独自旅行，所以观音答应，如果孙悟空担任僧侣的忠实弟子，她将安排孙悟空的自由。", "life_ex": "He was a righteous man who always stood up for what was right.", "life_cn": "他是一个正义的人，总是挺身而出维护正义。" },
            { "id": 27, "w": "retrieve", "type": "general", "en_def": "get or bring (something) back from somewhere", "cn": "找回", "vid_ex": "Pursued by a righteous monk named Tripitaka, he'd set out to retrieve scriptures from the West, but the path was too long and dangerous to travel alone, so Guanyin promised to arrange Sun Wukong's freedom if he had served as a monk's faithful disciple.", "vid_cn": "在一位名叫唐三藏的正义僧侣的追捕下，他出发去西方取经，但这条路太长太危险，不能独自旅行，所以观音答应，如果孙悟空担任僧侣的忠实弟子，她将安排孙悟空的自由。", "life_ex": "The dog retrieved the ball.", "life_cn": "狗找回了球。" },
            { "id": 28, "w": "disciple", "type": "general", "en_def": "a follower or student of a teacher, leader, or philosopher", "cn": "门徒", "vid_ex": "Pursued by a righteous monk named Tripitaka, he'd set out to retrieve scriptures from the West, but the path was too long and dangerous to travel alone, so Guanyin promised to arrange Sun Wukong's freedom if he had served as a monk's faithful disciple.", "vid_cn": "在一位名叫唐三藏的正义僧侣的追捕下，他出发去西方取经，但这条路太长太危险，不能独自旅行，所以观音答应，如果孙悟空担任僧侣的忠实弟子，她将安排孙悟空的自由。", "life_ex": "He was a faithful disciple of the guru.", "life_cn": "他是这位大师的忠实门徒。" },
            { "id": 29, "w": "hesitation", "type": "general", "en_def": "the act of pausing before doing something, especially because of nervousness or doubt", "cn": "犹豫", "vid_ex": "The Monkey King agreed without hesitation, and Guanyin directed Tripitaka to his mountain prison.", "vid_cn": "猴王毫不犹豫地同意了，观音指示唐三藏去他的山中监狱。", "life_ex": "She accepted the offer without hesitation.", "life_cn": "她毫不犹豫地接受了这个提议。" },
            { "id": 30, "w": "accosted", "type": "general", "en_def": "approach and address (someone) boldly or aggressively", "cn": "袭击", "vid_ex": "While the pair walked peacefully at first, they were soon accosted by fearsome bandits, and soon Wukong old habits pulled up.", "vid_cn": "当这对夫妇最初和平地行走时，他们很快受到了可怕的土匪的袭击，很快悟空的旧习惯又回来了。", "life_ex": "She was accosted by a stranger in the street.", "life_cn": "她在街上被一个陌生人袭击。" },
            { "id": 31, "w": "enraged", "type": "general", "en_def": "make (someone) very angry", "cn": "激怒", "vid_ex": "Tripitaka scolded the Monkey King, but this only enraged him further.", "vid_cn": "唐三藏责骂了猴王，但这只会进一步激怒他。", "life_ex": "The politician's comments enraged the public.", "life_cn": "这位政客的言论激怒了公众。" },
            { "id": 32, "w": "dejected", "type": "general", "en_def": "sad and dispirited", "cn": "沮丧的", "vid_ex": "His companion unable to continue alone, Tripitaka sat dejected until a strange woman approached him.", "vid_cn": "他的同伴无法独自继续前进，唐三藏沮丧地坐着，直到一个奇怪的女人走近他。", "life_ex": "She felt dejected after failing the exam.", "life_cn": "考试不及格后，她感到很沮丧。" },
            { "id": 33, "w": "sumptuous", "type": "general", "en_def": "splendid and expensive-looking", "cn": "奢华的", "vid_ex": "She gave him a sumptuous silk shirt and a cap hiding a band of gold alongside A mysterious spell.", "vid_cn": "她给了他一件奢华的丝绸衬衫和一顶帽子，帽子里藏着一条金色的带子，旁边还有一个神秘的咒语。", "life_ex": "The hotel room was sumptuous.", "life_cn": "这家酒店的房间很奢华。" },
            { "id": 34, "w": "scoffed", "type": "general", "en_def": "speak to someone or about something in a scornfully derisive or mocking way", "cn": "嘲笑", "vid_ex": "He'd sought refuge in the Dragon King's lair, where he discussed his troubles over tea, but the Dragon King only scoffed at his guest.", "vid_cn": "他曾在龙王的巢穴中寻求庇护，在那里他喝茶讨论自己的烦恼，但龙王只是嘲笑他的客人。", "life_ex": "He scoffed at my suggestion.", "life_cn": "他嘲笑了我的建议。" }
        ],
        "quizzes": {
            // Updated General Quiz (Part 1) - Corrected timestamps and questions
            "general": [
                {
                    "time": 37.8,
                    "type": "choice",
                    "q": "What did the Monkey King steal that led to his initial capture?",
                    "opts": ["A potion of immortality", "The Jade Emperor's crown", "A sacred seal", "A magical cudgel"],
                    "ans": 0,
                    "review": "After wrecking havoc across the heavens, pilfering a potion of immortality...",
                    "replay": { "start": 9.57, "end": 37.8 }
                },
                {
                    "time": 154.68,
                    "type": "choice",
                    "q": "What did Sun Wukong promise in exchange for Guanyin ending his torment?",
                    "opts": ["To relinquish his powers", "To pursue enlightenment", "To serve the Jade Emperor", "To remain imprisoned forever"],
                    "ans": 1,
                    "review": "He promised to pursue enlightenment if she would end his torment.",
                    "replay": { "start": 128.63, "end": 154.68 }
                },
                {
                    "time": 189.8,
                    "type": "choice",
                    "q": "What role was Sun Wukong to fulfill in Tripitaka's journey?",
                    "opts": ["A guide through the heavens", "A bodyguard against bandits", "A faithful disciple", "A negotiator with spirits"],
                    "ans": 2,
                    "review": "Guanyin promised to arrange Sun Wukong's freedom if he had served as a monk's faithful disciple.",
                    "replay": { "start": 159.51, "end": 189.8 }
                },
                {
                    "time": 263.39,
                    "type": "choice",
                    "q": "What did the Dragon King advise Sun Wukong to do in order to attain enlightenment?",
                    "opts": ["Embrace his ego", "Abandon his ego", "Challenge the Buddha again", "Seek more power"],
                    "ans": 1,
                    "review": "He told Sun Wukong that if he truly wanted to attain enlightenment, he would have to abandon his ego.",
                    "replay": { "start": 234.54, "end": 263.39 }
                }
            ],
            // Updated Detailed Quiz (Part 2) - New questions and timestamps
            "detailed": [
                {
                    "time": 37.8,
                    "type": "true/false",
                    "q": "The sweltering cage weakened the Monkey King (True/False).",
                    "opts": ["True", "False"],
                    "ans": 1,
                    "review": "False. Rather than cooking him to a crisp, the sweltering cage had inflamed its captive strength.",
                    "replay": { "start": 9.57, "end": 37.8 }
                },
                {
                    "time": 49.00,
                    "type": "choice",
                    "q": "Who did the Jade Emperor call on when he was desperate?",
                    "opts": ["The strongest warrior", "The Buddha", "Sun Wukong", "The Dragon King"],
                    "ans": 1,
                    "review": "Desperate, the Jade Emperor called on the only being stronger than he, the supreme power in all the heavens, the Buddha himself.",
                    "replay": { "start": 38.15, "end": 49.00 }
                },
                {
                    "time": 107.75,
                    "type": "cloze",
                    "q": "Sun Wukong was shocked to find he'd never left the ______ hand.",
                    "opts": ["Buddha's", "Emperor's"],
                    "ans": 0,
                    "review": "Looking back, he was shocked to find he'd never left the Buddha's hand.",
                    "replay": { "start": 80.67, "end": 107.75 }
                },
                {
                    "time": 154.71,
                    "type": "choice",
                    "q": "How long was Sun Wukong imprisoned before vowing to mend his ways?",
                    "opts": ["100 years", "500 years", "1000 years", "200 years"],
                    "ans": 1,
                    "review": "After 500 years of imprisonment, he'd grown increasingly desperate, finally vowing to mend his ways.",
                    "replay": { "start": 128.63, "end": 154.71 }
                },
                {
                    "time": 217.00,
                    "type": "choice",
                    "q": "What caused Sun Wukong to abandon Tripitaka?",
                    "opts": ["Bandits", "Scolding", "Imprisonment", "Illness"],
                    "ans": 1,
                    "review": "Tripitaka scolded the Monkey King, but this only enraged him further.",
                    "replay": { "start": 168.00, "end": 217.00 }
                },
                {
                    "time": 233.58,
                    "type": "true/false",
                    "q": "Tripitaka received a silk shirt, a cap, and a mysterious spell from the Emperor (True/False).",
                    "opts": ["True", "False"],
                    "ans": 1,
                    "review": "False. A strange woman (Guanyin) gave him a sumptuous silk shirt and a cap hiding a band of gold.",
                    "replay": { "start": 217.15, "end": 233.58 }
                },
                {
                    "time": 294.91,
                    "type": "choice",
                    "q": "What happened when Tripitaka recited the spell after Sun Wukong put on the cap?",
                    "opts": ["Sun Wukong gained immense power.", "The golden band tightened, causing pain.", "Tripitaka vanished.", "The Dragon King appeared."],
                    "ans": 1,
                    "review": "Suddenly, the golden band tightened around Sun Wukong's head, causing explosive pain.",
                    "replay": { "start": 279.55, "end": 294.91 }
                },
                {
                    "time": 315.57,
                    "type": "cloze",
                    "q": "Until Sun Wukong could control himself, Guan Yin had given Tripitaka control of the ______.",
                    "opts": ["Bandits", "Monkey King"],
                    "ans": 1,
                    "review": "Until Sun Wukong could control himself, Guan Yin had given him control of the Monkey King.",
                    "replay": { "start": 300.91, "end": 315.57 }
                }
            ]
        },
        "subtitles": [
            { "s": 9.57, "e": 26.31, "t": "After wrecking havoc across the heavens, pilfering a potion of immortality, and defeating the strongest warriors in the Jade Emperor's court, the Monkey King had finally been captured in a white hot prison cell." },
            { "s": 26.31, "e": 33.76, "t": "But rather than cooking him to a crisp, the sweltering cage had inflamed its captive strength." },
            { "s": 33.76, "e": 37.73, "t": "Now he was free once more and itching for a fight." },
            { "s": 38.15, "e": 48.79, "t": "Desperate, the Jade Emperor called on the only being stronger than he, the supreme power in all the heavens, the Buddha himself." },
            { "s": 49.71, "e": 55.39, "t": "Even in the face of this almighty opponent, Sun Wukong was not one to grovel." },
            { "s": 55.39, "e": 60.63, "t": "He began boasting of his many talents and demanded the Emperor's crown." },
            { "s": 60.63, "e": 68.08, "t": "Smiling, the Buddha declared he would grant that wish if Sun Wukong could somersault out of his palm." },
            { "s": 68.08, "e": 79.67, "t": "The Monkey King gladly pranced onto the Buddha's hand and shot into the air, landing in a far off region where 5 pink pillars seemed to mark the edge of the." },
            { "s": 80.67, "e": 85.46, "t": "Cackling with Glee, Sun Wukong proudly marked his territory." },
            { "s": 85.46, "e": 92.97, "t": "Returning to the Buddha, he demanded his new title, but he was distracted by a familiar odour." },
            { "s": 92.97, "e": 98.64, "t": "Looking back, he was shocked to find he'd never left the Buddha's hand." },
            { "s": 98.64, "e": 107.75, "t": "Suddenly, those five fingers transformed into a mountain range, which flipped and pinned Sun Wukong to the ground." },
            { "s": 108.23, "e": 117.87, "t": "Using a sacred seal, the Buddha secured the prison, trapping the Monkey King for good unless he could learn to change." },
            { "s": 117.87, "e": 127.91, "t": "Seeing the mystical tag, Sun Wukong knew he couldn't escape unaided, but it took centuries before he truly admitted defeat." },
            { "s": 128.63, "e": 135.68, "t": "After 500 years of imprisonment, he'd grown increasingly desperate, finally vowing to mend his ways." },
            { "s": 135.68, "e": 145.62, "t": "So when the bodhisattva Guanyin happened by his prison on a sacred journey, he promised to pursue enlightenment if she would end his torment." },
            { "s": 145.62, "e": 154.71, "t": "The goddess of Compassion was skeptical of Sun Wukong's change of heart, but decided to give him an opportunity to prove himself." },
            { "s": 155.52, "e": 158.96, "t": "At that time, the goddess was overseeing another sacred quest." },
            { "s": 159.51, "e": 179.21, "t": "Pursued by a righteous monk named Tripitaka, he'd set out to retrieve scriptures from the West, but the path was too long and dangerous to travel alone, so Guanyin promised to arrange Sun Wukong's freedom if he had served as a monk's faithful disciple." },
            { "s": 179.21, "e": 186.79, "t": "The Monkey King agreed without hesitation, and Guanyin directed Tripitaka to his mountain prison." },
            { "s": 187.87, "e": 195.44, "t": "After centuries of waiting, Sun Wukong was finally free, but he knew he had to behave himself." },
            { "s": 195.44, "e": 205.51, "t": "While the pair walked peacefully at first, they were soon accosted by fearsome bandits, and soon Wukong old habits pulled up." },
            { "s": 205.51, "e": 211.07, "t": "Tripitaka scolded the Monkey King, but this only enraged him further." },
            { "s": 211.07, "e": 216.95, "t": "Being good was far more boring than he had imagined, so he swiftly aband." },
            { "s": 217.15, "e": 225.58, "t": "His companion unable to continue alone, Tripitaka sat dejected until a strange woman approached him." },
            { "s": 225.58, "e": 233.75, "t": "She gave him a sumptuous silk shirt and a cap hiding a band of gold alongside A mysterious spell." },
            { "s": 234.39, "e": 240.47, "t": "It was only when she vanished that Tripitaka recognised her as his holy patron." },
            { "s": 240.47, "e": 244.24, "t": "Meanwhile, Sun Wukong was having second thoughts." },
            { "s": 244.24, "e": 254.54, "t": "He'd sought refuge in the Dragon King's lair, where he discussed his troubles over tea, but the Dragon King only scoffed at his guest." },
            { "s": 254.54, "e": 255.62, "t": "Wounded pride." },
            { "s": 255.62, "e": 263.39, "t": "He told Sun Wukong that if he truly wanted to attain enlightenment, he would have to abandon his ego." },
            { "s": 263.55, "e": 265.87, "t": "However painful that might be." },
            { "s": 266.55, "e": 278.19, "t": "His determination renewed, Sun Wu Kong returned to Tripitaka to apologize, but quickly spotted the luxurious shirt and cap." },
            { "s": 279.55, "e": 286.91, "t": "They fit the Monkey King perfectly, prompting Tripitaka to recite the spell out of curiosity." },
            { "s": 287.87, "e": 294.75, "t": "Suddenly, the golden band tightened around Sun Wukong's head, causing explosive pain." },
            { "s": 295.87, "e": 300.19, "t": "He became too weak to use his cudgel or somersault away." },
            { "s": 300.91, "e": 305.57, "t": "Only now did Tripitaka recognize the spell's power." },
            { "s": 305.57, "e": 313.79, "t": "Until Sun Wukong could control himself, Guan Yin had given him control of the Monkey King." },
            { "s": 315.67, "e": 319.87, "t": "Both parties were uneasy about this new arrangement." },
            { "s": 321.6, "e": 323.88, "t": "But they agreed it was for the good of their mission." },
            { "s": 325.39, "e": 335.87, "t": "Finally, the Monkey King was ready for his greatest challenge yet, an epic journey to the West and perhaps to redemption." },
            { "s": 339.5, "e": 347.45, "t": "The stories that we passed down help us better understand the past and sometimes even the present." },
            { "s": 347.45, "e": 351.34, "t": "Subscribe to this channel and never miss a myth." }
        ]
    };

    // State & Logic
    let s = { u:"", lsc:0, qsc:0, vidsc:0, sv:new Set(), lrn:new Set(), pg:'p1', v1:0, v2:0, lock:false, t1:0, t2:0, logs1:[], logs2:[], startTime: Date.now() };
    const AZ_KEY = D.config.azureKey; const AZ_REG = D.config.azureRegion;
    const STORAGE_KEY = 'vt_course_monkey_king_v3';

    window.onload = () => {
        if(localStorage.getItem(STORAGE_KEY)) document.getElementById('resume-btn').style.display='inline-block';
        initSubs();
        initVocabGrid(); // Dynamic Grid Generation
    };

    function startApp() {
        const n=document.getElementById('username').value;
        if(n) s.u=n;
        s.startTime = Date.now();
        toPage('p2');
    }

    function resumeApp() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;
        try {
            const saved = JSON.parse(raw);
            s.u = saved.u || "";
            s.lsc = saved.lsc || 0;
            s.qsc = saved.qsc || 0;
            s.vidsc = saved.vidsc || 0;
            s.pg = saved.pg || 'p1';
            s.v1 = saved.v1 || 0;
            s.v2 = saved.v2 || 0;
            s.t1 = saved.t1 || 0;
            s.t2 = saved.t2 || 0;
            s.logs1 = saved.logs1 || [];
            s.logs2 = saved.logs2 || [];
            s.sv = new Set(saved.sv || []);
            s.lrn = new Set(saved.lrn || []);

            if(s.u) document.getElementById('username').value = s.u;
            upUI(); 
            
            s.lrn.forEach(idx => {
                const el = document.getElementById('vc-' + idx);
                if(el) el.classList.add('learned');
            });
            s.sv.forEach(idx => {
                const el = document.getElementById('bm-' + idx);
                if(el) el.classList.add('saved');
            });
            toPage(s.pg);
        } catch (e) {
            console.error("Resume corrupted:", e);
            startApp();
        }
    }

    function toPage(p) {
        document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
        document.getElementById(p).classList.add('active');
        s.pg=p;
        if(p==='p5') { initVid(1); if(s.t1>0) restoreVid('vid1', s.t1); }
        if(p==='p6') { initVid(2); if(s.t2>0) restoreVid('vid2', s.t2); }
        if(p==='p7') genReport();
    }
    
    function restoreVid(id, t) {
        const v = document.getElementById(id);
        const attempt = () => {
            v.currentTime = t;
            if(Math.abs(v.currentTime - t) > 1) requestAnimationFrame(attempt);
        };
        if(v.readyState >= 1) attempt();
        else v.onloadedmetadata = attempt;
    }

    function genReport() {
        const timeSpent = Math.floor((Date.now() - s.startTime) / 60000);
        document.getElementById('r-name').innerText = s.u || "Traveler";
        document.getElementById('r-voc').innerText = s.lsc;
        document.getElementById('r-quiz').innerText = s.qsc;
        document.getElementById('r-vid').innerText = s.vidsc;
        document.getElementById('r-time').innerText = timeSpent + "m";
        document.getElementById('r-total').innerText = s.lsc + s.qsc + s.vidsc;
        localStorage.removeItem(STORAGE_KEY);
    }

    function speak(txt) {
        if(window.SpeechSDK && AZ_KEY) {
            const c = SpeechSDK.SpeechConfig.fromSubscription(AZ_KEY, AZ_REG);
            c.speechSynthesisVoiceName = "en-GB-RyanNeural";
            const a = SpeechSDK.AudioConfig.fromDefaultSpeakerOutput();
            const syn = new SpeechSDK.SpeechSynthesizer(c, a);
            syn.speakTextAsync(txt, r=>{syn.close()}, e=>{syn.close(); nativeSpeak(txt)});
        } else { nativeSpeak(txt); }
    }
    function nativeSpeak(txt) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(txt);
        u.lang = 'en-GB';
        window.speechSynthesis.speak(u);
    }

    // Dynamic Vocab Grid Generation (Ensures Sync)
    function initVocabGrid() {
        const c = document.getElementById('vocab-container');
        c.innerHTML = D.vocab.map(v => `
            <div class="flashcard" onclick="openVocab(${v.id})" id="vc-${v.id}">
                <div class="tag">${v.type}</div>
                <i class="fas fa-bookmark save-icon" id="bm-${v.id}" onclick="toggleSave(event, ${v.id})"></i>
                <div style="font-family:var(--font-head); font-size:1.3rem; font-weight:700; color:var(--primary); margin-top:10px;">${v.w}</div>
                <div style="color:var(--ink-light); font-size:0.9rem; margin-top:5px;">${v.en_def.substring(0,25)}...</div>
            </div>
        `).join('');
    }

    let tm;
    function openVocab(i) {
        const v = D.vocab[i];
        document.getElementById('mod-voc').style.display='flex';
        document.getElementById('vw').innerText=v.w;
        document.getElementById('vtype').innerText=v.type;
        document.getElementById('vdef').innerText=v.en_def;
        document.getElementById('vcn').innerText=v.cn;
        document.getElementById('vex1').innerText=v.vid_ex;
        document.getElementById('vcn1').innerText=v.vid_cn;
        document.getElementById('vex2').innerText=v.life_ex;
        document.getElementById('vcn2').innerText=v.life_cn;
        
        // Reset Blur
        document.querySelectorAll('.blur-txt').forEach(e=>e.classList.remove('show'));
        
        speak(v.w);
        clearTimeout(tm);
        tm = setTimeout(()=>{
            if(!s.lrn.has(i)) { s.lrn.add(i); s.lsc+=2; upUI(); saveState(); document.getElementById(`vc-${i}`).classList.add('learned'); }
        }, 3000); 
    }
    function clsVoc(){ document.getElementById('mod-voc').style.display='none'; clearTimeout(tm); }
    function toggleSave(e,i){ e.stopPropagation(); const el=document.getElementById(`bm-${i}`); if(s.sv.has(i)){ s.sv.delete(i); el.classList.remove('saved'); } else{ s.sv.add(i); el.classList.add('saved'); } saveState(); }

    let qQ=[], qC=0;
    function getMisspelling(word) {
        if(word.length < 4) return word + "e";
        const idx = Math.floor(Math.random() * (word.length - 2)) + 1;
        return word.substring(0, idx) + word[idx+1] + word[idx] + word.substring(idx+2);
    }

    function startQuiz(pct, base) {
        s.qsc += base; upUI();
        const n = Math.ceil(D.vocab.length * pct);
        const pool = [...D.vocab].sort(()=>0.5-Math.random()).slice(0, n);
        qQ = pool.map(v => {
            const r = Math.random();
            let type = 'def'; let opts = [];
            if(r < 0.33) {
                type = 'def'; opts = [v]; while(opts.length<4) { const x=D.vocab[Math.floor(Math.random()*D.vocab.length)]; if(!opts.includes(x)) opts.push(x); } opts = opts.sort(()=>0.5-Math.random()).map(o => ({txt: o.w, isC: o.id===v.id}));
            } else if (r < 0.66) {
                type = 'lis'; const dist1 = getMisspelling(v.w); const dist2 = getMisspelling(v.w); const dist3 = getMisspelling(v.w); opts = [{txt: v.w, isC: true}, {txt: dist1, isC: false}, {txt: dist2, isC: false}, {txt: dist3, isC: false}].sort(()=>0.5-Math.random());
            } else {
                type = 'cloze'; opts = [v]; while(opts.length<4) { const x=D.vocab[Math.floor(Math.random()*D.vocab.length)]; if(!opts.includes(x)) opts.push(x); } opts = opts.sort(()=>0.5-Math.random()).map(o => ({txt: o.w, isC: o.id===v.id}));
            }
            return { c:v, t:type, o:opts };
        });
        qC=0;
        document.getElementById('qz-setup').style.display='none';
        document.getElementById('qz-run').style.display='block';
        rendQ();
    }

    function rendQ() {
        if(qC>=qQ.length) { alert("Quiz Finished!"); toPage('p5'); return; }
        const q=qQ[qC];
        document.getElementById('q-idx').innerText=qC+1;
        document.getElementById('q-fb').style.display='none';
        document.getElementById('q-nxt').style.display='none';
        const b=document.getElementById('q-content'); b.innerHTML='';
        if(q.t==='lis') { b.innerHTML=`<div style="text-align:center; margin-bottom:20px;"><button class="btn btn-outline" style="border-radius:50%; width:60px; height:60px; font-size:1.5rem;" onclick="speak('${q.c.w}')"><i class="fas fa-volume-up"></i></button><br><small>Listen & Choose</small></div>`; } 
        else if (q.t==='cloze') { const sent = q.c.life_ex.replace(new RegExp(q.c.w, 'gi'), '_______'); b.innerHTML=`<div style="padding:20px; font-size:1.2rem; text-align:center; font-family:var(--font-head);">"${sent}"</div>`; } 
        else { b.innerHTML=`<div style="padding:20px; font-weight:bold; font-size:1.1rem; text-align:center;">${q.c.en_def}</div>`; }
        q.o.forEach(opt=>{
            const btn=document.createElement('div'); btn.className='opt-btn'; btn.innerText=opt.txt;
            btn.onclick=()=>chkQ(btn, opt.isC, q.c);
            b.appendChild(btn);
        });
    }

    // Updated Check Function to Include Feedback and Examples
    function chkQ(btn, isC, dat) {
        document.querySelectorAll('#q-content .opt-btn').forEach(b=>b.style.pointerEvents='none');
        if(isC) { btn.classList.add('sel-correct'); s.qsc+=2; } 
        else { btn.classList.add('sel-wrong'); s.qsc-=1; }
        upUI(); saveState();
        
        // Detailed Feedback Restored
        const fb=document.getElementById('q-fb'); fb.style.display='block';
        fb.className = isC ? 'feedback-box correct' : 'feedback-box wrong';
        fb.innerHTML = `
            <div style="font-weight:bold; font-size:1.1rem; margin-bottom:5px;">${dat.w} <span style="font-weight:normal; color:#666;">${dat.cn}</span></div>
            <div style="font-style:italic;">"${dat.life_ex}"</div>
            <div style="color:#666; font-size:0.9rem;">${dat.life_cn}</div>
        `;
        
        const nx=document.getElementById('q-nxt'); nx.style.display='block';
        let sec=3; nx.innerText=`Next (${sec})`;
        const ti=setInterval(()=>{ sec--; nx.innerText=`Next (${sec})`; if(sec<=0){ clearInterval(ti); qC++; rendQ(); } },1000);
        nx.onclick=()=>{ clearInterval(ti); qC++; rendQ(); };
    }
    function nextQ() { qC++; rendQ(); }

    let curVQ=null;
    function initVid(id) {
        const v=document.getElementById(`vid${id}`);
        const qs=id===1 ? D.quizzes.general : D.quizzes.detailed;
        
        upHud(id, qs); 

        v.ontimeupdate = () => {
            if(id===1) s.t1 = v.currentTime; else s.t2 = v.currentTime;
            saveState();
            const t=v.currentTime;
            const i=id===1?s.v1:s.v2;
            const sl=document.getElementById(`sk${id}`);
            sl.value=(t/v.duration)*100 || 0; 

            if(i<qs.length) {
                if(t >= qs[i].time && !s.lock) { v.pause(); s.lock=true; popVQ(id, qs[i]); }
            }
            
            if(id===1) {
                const subIdx = D.subtitles.findIndex(x=>t>=x.s && t<=x.e);
                if(subIdx !== -1) {
                    document.querySelectorAll('.sub-line').forEach(e=>e.classList.remove('active'));
                    const el = document.getElementById(`sub-${subIdx}`);
                    if(el) { el.classList.add('active'); el.scrollIntoView({behavior:'smooth', block:'center'}); }
                }
            }
            if(t >= v.duration - 0.5) showReview(id);
        };
    }

    function upHud(id, qs) {
        const i=id===1?s.v1:s.v2;
        const h=document.getElementById(`hud${id}`);
        if(i < qs.length) { h.style.display='block'; h.innerText = "Next Q: " + qs[i].q; } else { h.style.display='none'; }
    }

    function popVQ(id, q) {
        curVQ=q;
        document.getElementById(`fb${id}`).style.display='none';
        document.getElementById(`ct${id}`).style.display='none';
        document.getElementById(`rp${id}`).style.display='inline-block';
        document.getElementById(`ol${id}`).style.display='flex';
        
        const cont = id===1 ? document.getElementById('v1-opts') : document.getElementById('v2-opts');
        cont.innerHTML = q.opts.map((o,idx)=>
            `<button class="opt-btn" onclick="ansUnified(${id}, ${idx}, ${q.ans})">${o}</button>`
        ).join('');
        
        document.getElementById(id===1 ? 'v1-q' : 'v2-q').innerText = q.q;
    }

    function ansUnified(id, idx, corr) {
        const cont = id===1 ? document.getElementById('v1-opts') : document.getElementById('v2-opts');
        const btns = cont.querySelectorAll('.opt-btn');
        btns.forEach(b => b.disabled=true);
        
        const isCorr = idx===corr;
        if(isCorr) { 
            btns[idx].classList.add('sel-correct'); 
            s.vidsc+=5;
        } else { 
            btns[idx].classList.add('sel-wrong'); 
            btns[corr].classList.add('sel-correct'); 
        }
        
        showFeedback(id, isCorr);
        if(id===1) s.logs1.push({ q: curVQ.q, uAns: curVQ.opts[idx], cAns: curVQ.opts[corr], isC: isCorr, exp: curVQ.review });
        else s.logs2.push({ q: curVQ.q, uAns: curVQ.opts[idx], cAns: curVQ.opts[corr], isC: isCorr, exp: curVQ.review });
    }

    function showFeedback(id, isCorr) {
        const fb = document.getElementById(`fb${id}`);
        fb.className = `feedback-box ${isCorr?'correct':'wrong'}`;
        fb.innerHTML = `<div style="font-weight:bold; margin-bottom:5px;">${isCorr ? '<i class="fas fa-check"></i> Correct' : '<i class="fas fa-times"></i> Incorrect'}</div><div>${curVQ.review}</div>`;
        fb.style.display='block';
        document.getElementById(`ct${id}`).style.display='inline-block';
        document.getElementById(`rp${id}`).style.display='none';
        upUI(); saveState();
    }

    function resume(id) {
        document.getElementById(`ol${id}`).style.display='none';
        s.lock=false;
        const v=document.getElementById(`vid${id}`);
        if(id===1) s.v1++; else s.v2++;
        const qs=id===1 ? D.quizzes.general : D.quizzes.detailed;
        upHud(id, qs); 
        v.play();
        upUI(); saveState();
    }

    function replaySeg(id) {
        const v=document.getElementById(`vid${id}`);
        const start = (curVQ.replay && curVQ.replay.start) ? curVQ.replay.start : Math.max(0, v.currentTime - 15);
        v.currentTime = start;
        document.getElementById(`ol${id}`).style.display='none';
        s.lock = false;
        v.play();
    }

    function showReview(id) {
        const el = document.getElementById(`rev${id}`);
        const list = document.getElementById(`rev${id}-list`);
        const logs = id===1 ? s.logs1 : s.logs2;
        list.innerHTML = logs.map(l => `<div style="background:#f8f8f8; padding:15px; margin-bottom:10px; border-radius:8px; border-left:4px solid ${l.isC?'#48bb78':'#f56565'}"><div style="font-weight:bold; margin-bottom:5px;">${l.q}</div><div style="font-size:0.9rem; color:#666;">Your Ans: ${l.uAns}</div><div style="font-size:0.9rem; margin-top:5px; color:${l.isC?'green':'red'}">${l.exp}</div></div>`).join('');
        el.style.display = 'flex';
        document.getElementById(`vid${id}`).pause();
    }

    function playVid(id){ const v=document.getElementById(`vid${id}`); const i=document.getElementById(`icon${id}`); v.paused?v.play():v.pause(); i.className=v.paused?'fas fa-play':'fas fa-pause'; }
    function spd(id,v){ document.getElementById(`vid${id}`).playbackRate=v; }
    function upUI(){ document.getElementById('u-score').innerText = s.lsc + s.qsc + s.vidsc; }
    function saveState(alertUser){ localStorage.setItem(STORAGE_KEY, JSON.stringify({...s, sv:[...s.sv], lrn:[...s.lrn]})); if(alertUser) alert("Progress Saved!"); }
    
    function initSubs() {
        const c=document.getElementById('subs1');
        D.subtitles.forEach((x,i)=>{
            const d=document.createElement('div'); d.className='sub-line'; d.id=`sub-${i}`;
            const t = x.t.split(' ').map(w=>`<span onclick="ds('${w.replace(/[^\w]/g,'')}')">${w}</span>`).join(' ');
            d.innerHTML=`<small style="color:#aaa; margin-right:8px; font-family:monospace;">${Math.floor(x.s/60)}:${Math.floor(x.s%60).toString().padStart(2,'0')}</small>${t}`;
            c.appendChild(d);
        });
    }
    
    async function ds(w) {
        if(!w) return;
        const p=document.getElementById('ds-pop'); p.style.display='block';
        document.getElementById('ds-con').innerHTML='<i class="fas fa-circle-notch fa-spin"></i> Consulting AI...';
        try {
            const r=await fetch("https://api.deepseek.com/v1/chat/completions", {
                method:"POST", headers:{"Content-Type":"application/json", "Authorization":`Bearer ${D.config.deepseekKey}`},
                body: JSON.stringify({model:"deepseek-chat", messages:[{role:"user", content:`Define "${w}" for B1 student. JSON: {cn, en, ex}`}], response_format:{type:"json_object"}})
            });
            const d=JSON.parse((await r.json()).choices[0].message.content);
            document.getElementById('ds-con').innerHTML=`<div style="font-size:1.5rem; font-weight:800; color:#2d3748; margin-bottom:5px;">${w}</div><div style="font-size:1.1rem; color:#718096; margin-bottom:10px;">${d.cn}</div><div style="font-style:italic; color:#4a5568; margin-bottom:15px; border-left:3px solid var(--accent); padding-left:10px;">${d.en}</div><div style="background:#f7fafc; padding:10px; border-radius:6px; font-size:0.9rem; color:#2c5282;">${d.ex}</div>`;
        } catch(e) { document.getElementById('ds-con').innerText="The scrolls are silent (API Error)."; }
    }

    let si=0;
    function slide(n){ const im=document.querySelectorAll('.slide-img'); im[si].style.display='none'; si=(si+n+im.length)%im.length; im[si].style.display='block'; }
</script>
</body>
</html>